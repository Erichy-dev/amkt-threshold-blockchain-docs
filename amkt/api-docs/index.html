<!DOCTYPE html><html><head>
      <title>index</title>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      
      <link rel="stylesheet" href="file:////Users/mac/.cursor/extensions/shd101wyy.markdown-preview-enhanced-0.8.15/crossnote/dependencies/katex/katex.min.css">
      
      
      
      
      
      <style>
      code[class*=language-],pre[class*=language-]{color:#333;background:0 0;font-family:Consolas,"Liberation Mono",Menlo,Courier,monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.4;-moz-tab-size:8;-o-tab-size:8;tab-size:8;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:.8em;overflow:auto;border-radius:3px;background:#f5f5f5}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal;background:#f5f5f5}.token.blockquote,.token.comment{color:#969896}.token.cdata{color:#183691}.token.doctype,.token.macro.property,.token.punctuation,.token.variable{color:#333}.token.builtin,.token.important,.token.keyword,.token.operator,.token.rule{color:#a71d5d}.token.attr-value,.token.regex,.token.string,.token.url{color:#183691}.token.atrule,.token.boolean,.token.code,.token.command,.token.constant,.token.entity,.token.number,.token.property,.token.symbol{color:#0086b3}.token.prolog,.token.selector,.token.tag{color:#63a35c}.token.attr-name,.token.class,.token.class-name,.token.function,.token.id,.token.namespace,.token.pseudo-class,.token.pseudo-element,.token.url-reference .token.variable{color:#795da3}.token.entity{cursor:help}.token.title,.token.title .token.punctuation{font-weight:700;color:#1d3e81}.token.list{color:#ed6a43}.token.inserted{background-color:#eaffea;color:#55a532}.token.deleted{background-color:#ffecec;color:#bd2c00}.token.bold{font-weight:700}.token.italic{font-style:italic}.language-json .token.property{color:#183691}.language-markup .token.tag .token.punctuation{color:#333}.language-css .token.function,code.language-css{color:#0086b3}.language-yaml .token.atrule{color:#63a35c}code.language-yaml{color:#183691}.language-ruby .token.function{color:#333}.language-markdown .token.url{color:#795da3}.language-makefile .token.symbol{color:#795da3}.language-makefile .token.variable{color:#183691}.language-makefile .token.builtin{color:#0086b3}.language-bash .token.keyword{color:#0086b3}pre[data-line]{position:relative;padding:1em 0 1em 3em}pre[data-line] .line-highlight-wrapper{position:absolute;top:0;left:0;background-color:transparent;display:block;width:100%}pre[data-line] .line-highlight{position:absolute;left:0;right:0;padding:inherit 0;margin-top:1em;background:hsla(24,20%,50%,.08);background:linear-gradient(to right,hsla(24,20%,50%,.1) 70%,hsla(24,20%,50%,0));pointer-events:none;line-height:inherit;white-space:pre}pre[data-line] .line-highlight:before,pre[data-line] .line-highlight[data-end]:after{content:attr(data-start);position:absolute;top:.4em;left:.6em;min-width:1em;padding:0 .5em;background-color:hsla(24,20%,50%,.4);color:#f4f1ef;font:bold 65%/1.5 sans-serif;text-align:center;vertical-align:.3em;border-radius:999px;text-shadow:none;box-shadow:0 1px #fff}pre[data-line] .line-highlight[data-end]:after{content:attr(data-end);top:auto;bottom:.4em}html body{font-family:'Helvetica Neue',Helvetica,'Segoe UI',Arial,freesans,sans-serif;font-size:16px;line-height:1.6;color:#333;background-color:#fff;overflow:initial;box-sizing:border-box;word-wrap:break-word}html body>:first-child{margin-top:0}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{line-height:1.2;margin-top:1em;margin-bottom:16px;color:#000}html body h1{font-size:2.25em;font-weight:300;padding-bottom:.3em}html body h2{font-size:1.75em;font-weight:400;padding-bottom:.3em}html body h3{font-size:1.5em;font-weight:500}html body h4{font-size:1.25em;font-weight:600}html body h5{font-size:1.1em;font-weight:600}html body h6{font-size:1em;font-weight:600}html body h1,html body h2,html body h3,html body h4,html body h5{font-weight:600}html body h5{font-size:1em}html body h6{color:#5c5c5c}html body strong{color:#000}html body del{color:#5c5c5c}html body a:not([href]){color:inherit;text-decoration:none}html body a{color:#08c;text-decoration:none}html body a:hover{color:#00a3f5;text-decoration:none}html body img{max-width:100%}html body>p{margin-top:0;margin-bottom:16px;word-wrap:break-word}html body>ol,html body>ul{margin-bottom:16px}html body ol,html body ul{padding-left:2em}html body ol.no-list,html body ul.no-list{padding:0;list-style-type:none}html body ol ol,html body ol ul,html body ul ol,html body ul ul{margin-top:0;margin-bottom:0}html body li{margin-bottom:0}html body li.task-list-item{list-style:none}html body li>p{margin-top:0;margin-bottom:0}html body .task-list-item-checkbox{margin:0 .2em .25em -1.8em;vertical-align:middle}html body .task-list-item-checkbox:hover{cursor:pointer}html body blockquote{margin:16px 0;font-size:inherit;padding:0 15px;color:#5c5c5c;background-color:#f0f0f0;border-left:4px solid #d6d6d6}html body blockquote>:first-child{margin-top:0}html body blockquote>:last-child{margin-bottom:0}html body hr{height:4px;margin:32px 0;background-color:#d6d6d6;border:0 none}html body table{margin:10px 0 15px 0;border-collapse:collapse;border-spacing:0;display:block;width:100%;overflow:auto;word-break:normal;word-break:keep-all}html body table th{font-weight:700;color:#000}html body table td,html body table th{border:1px solid #d6d6d6;padding:6px 13px}html body dl{padding:0}html body dl dt{padding:0;margin-top:16px;font-size:1em;font-style:italic;font-weight:700}html body dl dd{padding:0 16px;margin-bottom:16px}html body code{font-family:Menlo,Monaco,Consolas,'Courier New',monospace;font-size:.85em;color:#000;background-color:#f0f0f0;border-radius:3px;padding:.2em 0}html body code::after,html body code::before{letter-spacing:-.2em;content:'\00a0'}html body pre>code{padding:0;margin:0;word-break:normal;white-space:pre;background:0 0;border:0}html body .highlight{margin-bottom:16px}html body .highlight pre,html body pre{padding:1em;overflow:auto;line-height:1.45;border:#d6d6d6;border-radius:3px}html body .highlight pre{margin-bottom:0;word-break:normal}html body pre code,html body pre tt{display:inline;max-width:initial;padding:0;margin:0;overflow:initial;line-height:inherit;word-wrap:normal;background-color:transparent;border:0}html body pre code:after,html body pre code:before,html body pre tt:after,html body pre tt:before{content:normal}html body blockquote,html body dl,html body ol,html body p,html body pre,html body ul{margin-top:0;margin-bottom:16px}html body kbd{color:#000;border:1px solid #d6d6d6;border-bottom:2px solid #c7c7c7;padding:2px 4px;background-color:#f0f0f0;border-radius:3px}@media print{html body{background-color:#fff}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{color:#000;page-break-after:avoid}html body blockquote{color:#5c5c5c}html body pre{page-break-inside:avoid}html body table{display:table}html body img{display:block;max-width:100%;max-height:100%}html body code,html body pre{word-wrap:break-word;white-space:pre}}.markdown-preview{width:100%;height:100%;box-sizing:border-box}.markdown-preview ul{list-style:disc}.markdown-preview ul ul{list-style:circle}.markdown-preview ul ul ul{list-style:square}.markdown-preview ol{list-style:decimal}.markdown-preview ol ol,.markdown-preview ul ol{list-style-type:lower-roman}.markdown-preview ol ol ol,.markdown-preview ol ul ol,.markdown-preview ul ol ol,.markdown-preview ul ul ol{list-style-type:lower-alpha}.markdown-preview .newpage,.markdown-preview .pagebreak{page-break-before:always}.markdown-preview pre.line-numbers{position:relative;padding-left:3.8em;counter-reset:linenumber}.markdown-preview pre.line-numbers>code{position:relative}.markdown-preview pre.line-numbers .line-numbers-rows{position:absolute;pointer-events:none;top:1em;font-size:100%;left:0;width:3em;letter-spacing:-1px;border-right:1px solid #999;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.markdown-preview pre.line-numbers .line-numbers-rows>span{pointer-events:none;display:block;counter-increment:linenumber}.markdown-preview pre.line-numbers .line-numbers-rows>span:before{content:counter(linenumber);color:#999;display:block;padding-right:.8em;text-align:right}.markdown-preview .mathjax-exps .MathJax_Display{text-align:center!important}.markdown-preview:not([data-for=preview]) .code-chunk .code-chunk-btn-group{display:none}.markdown-preview:not([data-for=preview]) .code-chunk .status{display:none}.markdown-preview:not([data-for=preview]) .code-chunk .output-div{margin-bottom:16px}.markdown-preview .md-toc{padding:0}.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link{display:inline;padding:.25rem 0}.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link div,.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link p{display:inline}.markdown-preview .md-toc .md-toc-link-wrapper.highlighted .md-toc-link{font-weight:800}.scrollbar-style::-webkit-scrollbar{width:8px}.scrollbar-style::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}.scrollbar-style::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,.66);border:4px solid rgba(150,150,150,.66);background-clip:content-box}html body[for=html-export]:not([data-presentation-mode]){position:relative;width:100%;height:100%;top:0;left:0;margin:0;padding:0;overflow:auto}html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{position:relative;top:0;min-height:100vh}@media screen and (min-width:914px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{padding:2em calc(50% - 457px + 2em)}}@media screen and (max-width:914px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{font-size:14px!important;padding:1em}}@media print{html body[for=html-export]:not([data-presentation-mode]) #sidebar-toc-btn{display:none}}html body[for=html-export]:not([data-presentation-mode]) #sidebar-toc-btn{position:fixed;bottom:8px;left:8px;font-size:28px;cursor:pointer;color:inherit;z-index:99;width:32px;text-align:center;opacity:.4}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] #sidebar-toc-btn{opacity:1}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc{position:fixed;top:0;left:0;width:300px;height:100%;padding:32px 0 48px 0;font-size:14px;box-shadow:0 0 4px rgba(150,150,150,.33);box-sizing:border-box;overflow:auto;background-color:inherit}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar{width:8px}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,.66);border:4px solid rgba(150,150,150,.66);background-clip:content-box}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc a{text-decoration:none}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc{padding:0 16px}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link{display:inline;padding:.25rem 0}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link div,html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link p{display:inline}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper.highlighted .md-toc-link{font-weight:800}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{left:300px;width:calc(100% - 300px);padding:2em calc(50% - 457px - 300px / 2);margin:0;box-sizing:border-box}@media screen and (max-width:1274px){html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{width:100%}}html body[for=html-export]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .markdown-preview{left:50%;transform:translateX(-50%)}html body[for=html-export]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .md-sidebar-toc{display:none}
/* Please visit the URL below for more information: */
/*   https://shd101wyy.github.io/markdown-preview-enhanced/#/customize-css */

      </style>
      <!-- The content below will be included at the end of the <head> element. --><script type="text/javascript">
  document.addEventListener("DOMContentLoaded", function () {
    // your code here
  });
</script></head><body for="html-export">
    
    
      <div class="crossnote markdown-preview  ">
      
<h1 id="amkt-v2-api-documentation">AMKT v2 API Documentation </h1>
<h2 id="overview">Overview </h2>
<h3 id="system-relationship-diagram">System Relationship Diagram </h3>
<p><img src="https://raw.githubusercontent.com/Alongside-Finance/amkt-v2/main/misc/diagrams/system.png" alt="Core System Relationship Diagram"><br>
<em>This diagram provides a high-level overview of the system and its core functions.</em></p>
<h1 id="alongside-crypto-market-index-v2">Alongside Crypto Market Index v2 </h1>
<p>Alongside Crypto Market Index (AMKT) is a fully backed market index, providing exposure to a market-cap weighted basket of assets, to be rebalanced quarterly.</p>
<p>The next iteration of AMKT moves custody on-chain, relying on <code>Vault</code> to custody underlying assets, and on governance to submit accurate <code>Bounty</code> for the next set of underlying assets to rebalance.</p>
<h2 id="table-of-contents">Table of Contents </h2>
<ul>
<li><a href="#amkt-v2-api-documentation">AMKT v2 API Documentation</a>
<ul>
<li><a href="#overview">Overview</a>
<ul>
<li><a href="#system-relationship-diagram">System Relationship Diagram</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#alongside-crypto-market-index-v2">Alongside Crypto Market Index v2</a>
<ul>
<li><a href="#table-of-contents">Table of Contents</a></li>
<li><a href="#overview-1">Overview</a>
<ul>
<li><a href="#system-relationship-diagram-1">System Relationship Diagram</a></li>
<li><a href="#amkt">AMKT</a></li>
<li><a href="#core">Core</a></li>
<li><a href="#governance">Governance</a></li>
</ul>
</li>
<li><a href="#local-development">Local Development</a>
<ul>
<li><a href="#tests">Tests</a></li>
<li><a href="#rebalance">Rebalance</a></li>
</ul>
</li>
<li><a href="#links">Links</a></li>
<li><a href="#installation-guide-installation-guide">Installation Guide {#installation-guide}</a>
<ul>
<li><a href="#prerequisites-prerequisites">Prerequisites {#prerequisites}</a></li>
<li><a href="#installation-steps-installation-steps">Installation Steps {#installation-steps}</a>
<ul>
<li><a href="#1-clone-the-repository">1. Clone the Repository</a></li>
<li><a href="#2-install-dependencies">2. Install Dependencies</a></li>
<li><a href="#3-set-up-foundry">3. Set Up Foundry</a></li>
<li><a href="#4-set-up-halmos">4. Set Up Halmos</a></li>
<li><a href="#5-build-the-contracts">5. Build the Contracts</a></li>
<li><a href="#6-run-tests">6. Run Tests</a></li>
<li><a href="#7-additional-setup-for-rebalance-sdk">7. Additional Setup for Rebalance SDK</a></li>
</ul>
</li>
<li><a href="#next-steps-next-steps">Next Steps {#next-steps}</a></li>
</ul>
</li>
<li><a href="#core-contracts-core-contracts">Core Contracts {#core-contracts}</a>
<ul>
<li><a href="#vault-contract-vault-contract">Vault Contract {#vault-contract}</a>
<ul>
<li><a href="#state-variables">State Variables</a></li>
<li><a href="#core-functions">Core Functions</a>
<ul>
<li><a href="#virtual-units-management">Virtual Units Management</a></li>
<li><a href="#asset-management">Asset Management</a>
<ul>
<li><a href="#token-operations">Token Operations</a></li>
<li><a href="#fee-management">Fee Management</a></li>
<li><a href="#emergency-controls">Emergency Controls</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#issuance-contract-issuance-contract">Issuance Contract {#issuance-contract}</a>
<ul>
<li><a href="#core-functions-1">Core Functions</a>
<ul>
<li><a href="#token-issuance">Token Issuance</a></li>
<li><a href="#token-redemption">Token Redemption</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#invokeablebounty-contract-invokeable-bounty-contract">InvokeableBounty Contract {#invokeable-bounty-contract}</a>
<ul>
<li><a href="#core-functions-2">Core Functions</a>
<ul>
<li><a href="#bounty-fulfillment">Bounty Fulfillment</a></li>
<li><a href="#bounty-struct">Bounty Struct</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#events-events">Events {#events}</a>
<ul>
<li><a href="#vault-events">Vault Events</a></li>
<li><a href="#issuance-events">Issuance Events</a></li>
<li><a href="#bounty-events">Bounty Events</a></li>
</ul>
</li>
<li><a href="#modifiers">Modifiers</a></li>
<li><a href="#error-codes">Error Codes</a></li>
<li><a href="#integration-examples">Integration Examples</a>
<ul>
<li><a href="#issuing-amkt">Issuing AMKT</a></li>
<li><a href="#redeeming-amkt">Redeeming AMKT</a></li>
</ul>
</li>
<li><a href="#security-considerations-security-considerations">Security Considerations {#security-considerations}</a></li>
<li><a href="#gas-optimization-notes">Gas Optimization Notes</a></li>
</ul>
</li>
<li><a href="#amkt-v2-rebalance-api-documentation">AMKT v2 Rebalance API Documentation</a>
<ul>
<li><a href="#overview-2">Overview</a></li>
<li><a href="#rebalance-sdk">Rebalance SDK</a>
<ul>
<li><a href="#installation">Installation</a></li>
<li><a href="#core-components">Core Components</a>
<ul>
<li><a href="#1-bounty-structure">1. Bounty Structure</a></li>
</ul>
</li>
<li><a href="#2-rebalance-configuration">2. Rebalance Configuration</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#smart-contract-interface">Smart Contract Interface</a>
<ul>
<li><a href="#invokeablebounty-contract">InvokeableBounty Contract</a>
<ul>
<li><a href="#setting-a-new-bounty">Setting a New Bounty</a></li>
<li><a href="#fulfilling-a-bounty">Fulfilling a Bounty</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#rebalance-process">Rebalance Process</a>
<ul>
<li><a href="#1-preparation-phase">1. Preparation Phase</a></li>
<li><a href="#2-governance-proposal">2. Governance Proposal</a></li>
<li><a href="#3-execution">3. Execution</a></li>
</ul>
</li>
<li><a href="#events">Events</a></li>
<li><a href="#error-codes-1">Error Codes</a></li>
<li><a href="#usage-examples">Usage Examples</a>
<ul>
<li><a href="#1-calculate-rebalance-requirements">1. Calculate Rebalance Requirements</a></li>
<li><a href="#2-submit-rebalance-proposal">2. Submit Rebalance Proposal</a></li>
<li><a href="#3-execute-rebalance">3. Execute Rebalance</a></li>
</ul>
</li>
<li><a href="#security-considerations">Security Considerations</a></li>
<li><a href="#best-practices">Best Practices</a></li>
<li><a href="#governance-api-governance-api">Governance API {#governance-api}</a>
<ul>
<li><a href="#overview-governance-overview">Overview {#governance-overview}</a></li>
<li><a href="#core-components-governance-components">Core Components {#governance-components}</a>
<ul>
<li><a href="#timelockcontroller-timelock-controller">TimelockController {#timelock-controller}</a>
<ul>
<li><a href="#key-parameters">Key Parameters</a></li>
<li><a href="#core-functions-3">Core Functions</a></li>
</ul>
</li>
<li><a href="#governance-contract-governance-contract">Governance Contract {#governance-contract}</a>
<ul>
<li><a href="#voting-parameters">Voting Parameters</a></li>
</ul>
</li>
<li><a href="#key-functions">Key Functions</a></li>
</ul>
</li>
<li><a href="#governance-actions-governance-actions">Governance Actions {#governance-actions}</a>
<ul>
<li><a href="#rebalance-process-rebalance-process">Rebalance Process {#rebalance-process}</a></li>
</ul>
</li>
<li><a href="#vault-configuration">Vault Configuration</a></li>
<li><a href="#role-management">Role Management</a></li>
<li><a href="#security-measures-security-measures">Security Measures {#security-measures}</a>
<ul>
<li><a href="#governance-multisig-governance-multisig">Governance Multisig {#governance-multisig}</a>
<ul>
<li><a href="#capabilities">Capabilities</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#participation-guide-participation-guide">Participation Guide {#participation-guide}</a>
<ul>
<li><a href="#1-token-voting">1. Token Voting</a></li>
</ul>
</li>
<li><a href="#2-proposal-creation">2. Proposal Creation</a></li>
<li><a href="#3-voting-process">3. Voting Process</a></li>
<li><a href="#events-governance-events">Events {#governance-events}</a></li>
</ul>
</li>
<li><a href="#integration-examples-1">Integration Examples</a>
<ul>
<li><a href="#creating-a-proposal">Creating a Proposal</a></li>
<li><a href="#voting-on-a-proposal">Voting on a Proposal</a></li>
</ul>
</li>
<li><a href="#error-codes-2">Error Codes</a></li>
<li><a href="#events-api-documentation">Events API Documentation</a>
<ul>
<li><a href="#overview-3">Overview</a></li>
<li><a href="#core-events">Core Events</a>
<ul>
<li><a href="#vault-events-1">Vault Events</a>
<ul>
<li><a href="#tokensdeposited">TokensDeposited</a></li>
<li><a href="#tokenswithdrawn">TokensWithdrawn</a></li>
</ul>
</li>
<li><a href="#rebalance-events">Rebalance Events</a>
<ul>
<li><a href="#rebalanceinitiated">RebalanceInitiated</a></li>
<li><a href="#rebalancecompleted">RebalanceCompleted</a></li>
</ul>
</li>
<li><a href="#governance-events">Governance Events</a>
<ul>
<li><a href="#proposalcreated">ProposalCreated</a></li>
<li><a href="#proposalexecuted">ProposalExecuted</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#emergency-events">Emergency Events</a>
<ul>
<li><a href="#emergencypaused">EmergencyPaused</a></li>
<li><a href="#emergencyunpaused">EmergencyUnpaused</a></li>
</ul>
</li>
<li><a href="#usage-examples-1">Usage Examples</a>
<ul>
<li><a href="#listening-for-events-web3js">Listening for Events (Web3.js)</a></li>
<li><a href="#querying-historical-events-ethersjs">Querying Historical Events (Ethers.js)</a></li>
</ul>
</li>
<li><a href="#event-monitoring-best-practices">Event Monitoring Best Practices</a></li>
<li><a href="#security-considerations-1">Security Considerations</a></li>
</ul>
</li>
<li><a href="#error-codes-documentation">Error Codes Documentation</a>
<ul>
<li><a href="#overview-4">Overview</a></li>
<li><a href="#core-errors">Core Errors</a>
<ul>
<li><a href="#vault-errors">Vault Errors</a>
<ul>
<li><a href="#insufficientbalance">InsufficientBalance</a></li>
<li><a href="#invalidtoken">InvalidToken</a></li>
<li><a href="#maxcapacityexceeded">MaxCapacityExceeded</a></li>
</ul>
</li>
<li><a href="#rebalance-errors">Rebalance Errors</a>
<ul>
<li><a href="#invalidbounty">InvalidBounty</a></li>
<li><a href="#expiredbounty">ExpiredBounty</a></li>
<li><a href="#slippageexceeded">SlippageExceeded</a></li>
</ul>
</li>
<li><a href="#governance-errors">Governance Errors</a>
<ul>
<li><a href="#unauthorizedproposer">UnauthorizedProposer</a></li>
<li><a href="#invalidproposalstate">InvalidProposalState</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#access-control-errors">Access Control Errors</a>
<ul>
<li><a href="#unauthorized">Unauthorized</a></li>
<li><a href="#invalidmultisig">InvalidMultisig</a></li>
</ul>
</li>
<li><a href="#error-handling-examples">Error Handling Examples</a>
<ul>
<li><a href="#contract-level">Contract Level</a></li>
<li><a href="#client-level-typescript">Client Level (TypeScript)</a></li>
</ul>
</li>
<li><a href="#error-handling-best-practices">Error Handling Best Practices</a></li>
<li><a href="#error-monitoring">Error Monitoring</a></li>
<li><a href="#security-implications">Security Implications</a></li>
</ul>
</li>
<li><a href="#testing-documentation-testing-documentation">Testing Documentation {#testing-documentation}</a>
<ul>
<li><a href="#overview-testing-overview">Overview {#testing-overview}</a></li>
<li><a href="#foundry-tests-foundry-tests">Foundry Tests {#foundry-tests}</a>
<ul>
<li><a href="#setup">Setup</a></li>
<li><a href="#test-structure">Test Structure</a></li>
<li><a href="#key-test-commands">Key Test Commands</a></li>
</ul>
</li>
<li><a href="#symbolic-testing-with-halmos-symbolic-testing">Symbolic Testing with Halmos {#symbolic-testing}</a>
<ul>
<li><a href="#setup-1">Setup</a></li>
<li><a href="#key-test-areas">Key Test Areas</a>
<ul>
<li><a href="#1-state-invariants">1. State Invariants</a></li>
<li><a href="#2-access-control">2. Access Control</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#test-coverage-test-coverage">Test Coverage {#test-coverage}</a></li>
<li><a href="#testing-best-practices-testing-best-practices">Testing Best Practices {#testing-best-practices}</a>
<ul>
<li><a href="#1-test-organization">1. Test Organization</a></li>
<li><a href="#2-common-test-scenarios-test-scenarios">2. Common Test Scenarios {#test-scenarios}</a>
<ul>
<li><a href="#vault-testing">Vault Testing</a></li>
<li><a href="#issuance-testing">Issuance Testing</a></li>
<li><a href="#bounty-testing">Bounty Testing</a></li>
</ul>
</li>
<li><a href="#3-fuzzing-parameters-fuzzing-parameters">3. Fuzzing Parameters {#fuzzing-parameters}</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#cicd-integration-and-testing-guide">CI/CD Integration and Testing Guide</a>
<ul>
<li><a href="#cicd-integration">CI/CD Integration</a>
<ul>
<li><a href="#github-actions-workflow">GitHub Actions Workflow</a></li>
</ul>
</li>
<li><a href="#debugging-tools">Debugging Tools</a>
<ul>
<li><a href="#trace-logging">Trace Logging</a></li>
<li><a href="#gas-snapshots">Gas Snapshots</a></li>
<li><a href="#debug-console">Debug Console</a></li>
</ul>
</li>
<li><a href="#common-issues-and-solutions">Common Issues and Solutions</a>
<ul>
<li><a href="#gas-estimation-failures">Gas Estimation Failures</a></li>
<li><a href="#memory-issues">Memory Issues</a></li>
<li><a href="#stack-too-deep">Stack Too Deep</a></li>
<li><a href="#additional-best-practices">Additional Best Practices</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#security-considerations-2">Security Considerations</a>
<ul>
<li><a href="#overview-5">Overview</a></li>
<li><a href="#access-control">Access Control</a>
<ul>
<li><a href="#role-based-permissions">Role-Based Permissions</a>
<ul>
<li><a href="#core-roles">Core Roles</a></li>
<li><a href="#implementation-example">Implementation Example</a></li>
</ul>
</li>
<li><a href="#time-locks">Time Locks</a>
<ul>
<li><a href="#governance-delay">Governance Delay</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#value-protection">Value Protection</a>
<ul>
<li><a href="#slippage-control">Slippage Control</a></li>
<li><a href="#circuit-breakers">Circuit Breakers</a></li>
</ul>
</li>
<li><a href="#smart-contract-security">Smart Contract Security</a>
<ul>
<li><a href="#reentrancy-protection">Reentrancy Protection</a></li>
<li><a href="#secure-token-transfers">Secure Token Transfers</a></li>
</ul>
</li>
<li><a href="#emergency-procedures">Emergency Procedures</a>
<ul>
<li><a href="#emergency-shutdown">Emergency Shutdown</a></li>
<li><a href="#fund-recovery">Fund Recovery</a></li>
</ul>
</li>
<li><a href="#monitoring-and-alerts">Monitoring and Alerts</a>
<ul>
<li><a href="#critical-events">Critical Events</a></li>
<li><a href="#monitoring-implementation">Monitoring Implementation</a></li>
</ul>
</li>
<li><a href="#security-best-practices">Security Best Practices</a></li>
</ul>
</li>
<li><a href="#security-considerations-3">Security Considerations</a>
<ul>
<li><a href="#overview-6">Overview</a></li>
<li><a href="#access-control-1">Access Control</a>
<ul>
<li><a href="#role-based-permissions-1">Role-Based Permissions</a>
<ul>
<li><a href="#core-roles-1">Core Roles</a></li>
<li><a href="#implementation-example-1">Implementation Example</a></li>
</ul>
</li>
<li><a href="#time-locks-1">Time Locks</a>
<ul>
<li><a href="#governance-delay-1">Governance Delay</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#value-protection-1">Value Protection</a>
<ul>
<li><a href="#slippage-control-1">Slippage Control</a></li>
<li><a href="#circuit-breakers-1">Circuit Breakers</a></li>
</ul>
</li>
<li><a href="#smart-contract-security-1">Smart Contract Security</a>
<ul>
<li><a href="#reentrancy-protection-1">Reentrancy Protection</a></li>
<li><a href="#secure-token-transfers-1">Secure Token Transfers</a></li>
</ul>
</li>
<li><a href="#emergency-procedures-1">Emergency Procedures</a>
<ul>
<li><a href="#emergency-shutdown-1">Emergency Shutdown</a></li>
<li><a href="#fund-recovery-1">Fund Recovery</a></li>
</ul>
</li>
<li><a href="#monitoring-and-alerts-1">Monitoring and Alerts</a>
<ul>
<li><a href="#critical-events-1">Critical Events</a></li>
<li><a href="#monitoring-implementation-1">Monitoring Implementation</a></li>
</ul>
</li>
<li><a href="#security-best-practices-1">Security Best Practices</a></li>
</ul>
</li>
<li><a href="#best-practices-1">Best Practices</a>
<ul>
<li><a href="#overview-7">Overview</a></li>
<li><a href="#code-development">Code Development</a>
<ul>
<li><a href="#solidity-patterns">Solidity Patterns</a>
<ul>
<li><a href="#safe-math-operations">Safe Math Operations</a></li>
<li><a href="#check-effects-interactions-pattern">Check-Effects-Interactions Pattern</a></li>
</ul>
</li>
<li><a href="#code-organization">Code Organization</a>
<ul>
<li><a href="#module-structure">Module Structure</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#testing-guidelines">Testing Guidelines</a>
<ul>
<li><a href="#unit-testing">Unit Testing</a></li>
<li><a href="#integration-testing">Integration Testing</a></li>
</ul>
</li>
<li><a href="#documentation-standards">Documentation Standards</a>
<ul>
<li><a href="#code-documentation">Code Documentation</a>
<ul>
<li><a href="#event-documentation">Event Documentation</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#deployment-process">Deployment Process</a>
<ul>
<li><a href="#deployment-checklist">Deployment Checklist</a></li>
<li><a href="#configuration-management">Configuration Management</a></li>
</ul>
</li>
<li><a href="#monitoring-and-maintenance">Monitoring and Maintenance</a>
<ul>
<li><a href="#health-checks">Health Checks</a></li>
<li><a href="#performance-optimization">Performance Optimization</a></li>
</ul>
</li>
<li><a href="#upgrade-procedures">Upgrade Procedures</a>
<ul>
<li><a href="#safe-upgrade-pattern">Safe Upgrade Pattern</a></li>
</ul>
</li>
<li><a href="#error-handling">Error Handling</a>
<ul>
<li><a href="#error-recovery">Error Recovery</a></li>
</ul>
</li>
<li><a href="#community-guidelines">Community Guidelines</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="overview-1">Overview </h2>
<h3 id="system-relationship-diagram-1">System Relationship Diagram </h3>
<p><img src="https://raw.githubusercontent.com/Alongside-Finance/amkt-v2/main/misc/diagrams/system.png" alt="Core System Relationship Diagram"><br>
<em>This diagram provides a high-level overview of the system and its core functions.</em></p>
<h3 id="amkt">AMKT </h3>
<p>AMKT is an <a href="contracts/lib/openzeppelin-contracts-upgradeable/contracts/token/ERC20/ERC20Upgradeable.sol">Upgradeable</a>, <a href="contracts/lib/openzeppelin-contracts-upgradeable/contracts/token/ERC20/extensions/ERC20VotesUpgradeable.sol">Votable</a>, ERC20 token on <a href="https://etherscan.io/token/0xf17a3fe536f8f7847f1385ec1bc967b2ca9cae8d">Ethereum Mainnet</a>.</p>
<h3 id="core">Core </h3>
<p>The core system aims to be modular and minimal for maximal safety and extensibility.</p>
<ul>
<li>
<p><a href="contracts/src/Vault.sol">Vault</a>: Source of truth for the index and custodian of assets.</p>
<ul>
<li><code>virtualUnits()</code> defines the amount of each asset required in the index.</li>
<li>Issuance is authorized to call <code>invokeERC20s()</code>, <code>invokeMint()</code>, and <code>invokeBurn()</code>.</li>
<li>InvokeableBounty is authorized to call <code>invokeERC20s()</code>, and <code>invokeSetNominals()</code>.</li>
<li>Fee Recipient is authorized to call <code>tryInflation()</code>, which will mint accrued fees to them and adjust <code>virtualUnits</code>to account for minted tokens.</li>
<li>Emergency Multisig is authorized to call <code>setEmergency</code>, which will pause token issuance and rebalance, but cannot not pause redemptions.</li>
<li>Governance owns Vault via TimelockController. It's able to change the configurations of the vault, including fee rate, as well as roles.</li>
</ul>
</li>
<li>
<p><a href="contracts/src/invoke/Issuance.sol">Issuance</a>: Entry point for issuing and redeeming AMKT.</p>
<ul>
<li><code>issue()</code> and <code>redeem()</code> are permisionless functions allowing conversion of underlying assets and AMKT.</li>
</ul>
</li>
<li>
<p><a href="contracts/src/invoke/Bounty.sol">InvokeableBounty</a>: Entry point for rebalancing the index.</p>
<ul>
<li><code>fulfillBounty()</code> is a permissioned function only callable by <code>fulfiller</code> of the <code>Bounty</code>. It calculates amount of tokens to exchange based on the <code>Bounty</code> and facilitates the exchange. It also modifies <code>virtualUnits</code> to reflect the rebalance.</li>
<li><a href="contracts/src/invoke/ActiveBounty.sol">ActiveBounty</a> maintains the currently active bounty. Governance is authorized to call <code>setHash()</code>, which will make a <code>Bounty</code> active.</li>
</ul>
</li>
</ul>
<h3 id="governance">Governance </h3>
<p>Governance is responsible for facilitating rebalances, configuring the Vault, and upgrading AMKT. Users can participate in governance with AMKT via <a href="https://tally.xyz/gov/amkt">Tally</a>. Every governance action besides rebalances is subject to a minimum delay of 4 days, enforced by the <code>TimelockController</code>.</p>
<p>To prevent against a malicious token Governance takeover, the Governance Multisig is the only entity authorized to cancel and execute transactions scheduled in <code>TimelockController</code>.</p>
<h2 id="local-development">Local Development </h2>
<h3 id="tests">Tests </h3>
<p>This repo primarily uses <a href="https://github.com/gakonst/foundry">Foundry</a> for testing.</p>
<p><code>cd contracts &amp;&amp; forge test</code></p>
<p>Additionally, <a href="https://github.com/a16z/halmos">Halmos</a> is used for symbolic testing.</p>
<p><code>cd contracts &amp;&amp; halmos</code></p>
<h3 id="rebalance">Rebalance </h3>
<p><code>sdk/rebalance</code> contains an example Rust program to assist users with preparing a rebalance proposal to Governance.</p>
<hr>
<h2 id="links">Links </h2>
<ul>
<li><a href="https://alongside.xyz/">Website</a></li>
<li><a href="https://twitter.com/alongsidefi">Twitter/X</a></li>
<li><a href="https://docs.amktdao.com/amkt-documentation/">Docs</a></li>
<li><a href="https://immunefi.com/bounty/alongside/">Bug Bounty</a></li>
<li><a href="https://discuss.amktdao.com/">DAO Forum</a></li>
<li><a href="https://tally.xyz/gov/amkt">DAO Governance</a></li>
</ul>
<h2 id="installation-guide">Installation Guide </h2>
<p>This guide will walk you through the steps necessary to set up the Alongside Crypto Market Index v2 project on your local machine.</p>
<h3 id="prerequisites">Prerequisites </h3>
<p>Before you begin, ensure you have the following installed on your system:</p>
<ul>
<li><strong>Git</strong>: For cloning the repository.</li>
<li><strong>Rust</strong>: Required for the rebalance SDK.</li>
<li><strong>Node.js &amp; npm</strong>: For managing JavaScript dependencies.</li>
<li><strong>Foundry</strong>: For testing smart contracts.</li>
<li><strong>Halmos</strong>: For symbolic testing.</li>
</ul>
<h3 id="installation-steps">Installation Steps </h3>
<h4 id="1-clone-the-repository">1. Clone the Repository </h4>
<p>Start by cloning the project repository from GitHub:</p>
<pre data-role="codeBlock" data-info="bash" class="language-bash bash"><code><span class="token function">git</span> clone https://github.com/Alongside-Finance/amkt-v2.git
<span class="token builtin class-name">cd</span> amkt-v2
</code></pre><h4 id="2-install-dependencies">2. Install Dependencies </h4>
<p>Navigate to the <code>contracts</code> directory and install the necessary dependencies:</p>
<pre data-role="codeBlock" data-info="bash" class="language-bash bash"><code><span class="token builtin class-name">cd</span> contracts
<span class="token function">npm</span> <span class="token function">install</span>
</code></pre><h4 id="3-set-up-foundry">3. Set Up Foundry </h4>
<p>Ensure Foundry is installed and set up for testing:</p>
<pre data-role="codeBlock" data-info="bash" class="language-bash bash"><code><span class="token comment"># Install Foundry</span>
<span class="token function">curl</span> <span class="token parameter variable">-L</span> https://foundry.paradigm.xyz <span class="token operator">|</span> <span class="token function">bash</span>
foundryup
</code></pre><h4 id="4-set-up-halmos">4. Set Up Halmos </h4>
<p>Install Halmos for symbolic testing:</p>
<pre data-role="codeBlock" data-info="bash" class="language-bash bash"><code><span class="token comment"># Follow the instructions on the Halmos GitHub page for installation</span>
<span class="token comment"># Example:</span>
<span class="token function">cargo</span> <span class="token function">install</span> halmos
</code></pre><h4 id="5-build-the-contracts">5. Build the Contracts </h4>
<p>Compile the smart contracts to ensure everything is set up correctly:</p>
<pre data-role="codeBlock" data-info="bash" class="language-bash bash"><code>forge build
</code></pre><h4 id="6-run-tests">6. Run Tests </h4>
<p>Verify the setup by running the test suite:</p>
<pre data-role="codeBlock" data-info="bash" class="language-bash bash"><code>forge <span class="token builtin class-name">test</span>
</code></pre><h4 id="7-additional-setup-for-rebalance-sdk">7. Additional Setup for Rebalance SDK </h4>
<p>If you plan to work with the rebalance SDK, ensure Rust is installed and set up:</p>
<pre data-role="codeBlock" data-info="bash" class="language-bash bash"><code><span class="token comment"># Install Rust</span>
<span class="token function">curl</span> <span class="token parameter variable">--proto</span> <span class="token string">'=https'</span> <span class="token parameter variable">--tlsv1.2</span> <span class="token parameter variable">-sSf</span> https://sh.rustup.rs <span class="token operator">|</span> <span class="token function">sh</span>
rustup update
</code></pre><p>Navigate to the SDK directory and build the Rust program:</p>
<pre data-role="codeBlock" data-info="bash" class="language-bash bash"><code><span class="token builtin class-name">cd</span> sdk/rebalance
<span class="token function">cargo</span> build
</code></pre><h3 id="next-steps">Next Steps </h3>
<p>You should now have the Alongside Crypto Market Index v2 project set up on your local machine. You can start exploring the codebase, running tests, and contributing to the project.</p>
<p>For further information, refer to the project's <a href="https://docs.amktdao.com/amkt-documentation/">documentation</a>.</p>
<h2 id="core-contracts">Core Contracts </h2>
<h3 id="vault-contract">Vault Contract </h3>
<p><strong>Location</strong>: <code>contracts/src/Vault.sol</code></p>
<h4 id="state-variables">State Variables </h4>
<pre data-role="codeBlock" data-info="solidity" class="language-solidity solidity"><code><span class="token builtin">address</span> <span class="token keyword keyword-public">public</span> feeRecipient<span class="token punctuation">;</span>
<span class="token builtin">uint256</span> <span class="token keyword keyword-public">public</span> feeRate<span class="token punctuation">;</span>
<span class="token keyword keyword-mapping">mapping</span><span class="token punctuation">(</span><span class="token builtin">address</span> <span class="token operator">=&gt;</span> <span class="token builtin">uint256</span><span class="token punctuation">)</span> <span class="token keyword keyword-public">public</span> virtualUnits<span class="token punctuation">;</span>
<span class="token builtin">bool</span> <span class="token keyword keyword-public">public</span> emergency<span class="token punctuation">;</span>
</code></pre><h4 id="core-functions">Core Functions </h4>
<h5 id="virtual-units-management">Virtual Units Management </h5>
<pre data-role="codeBlock" data-info="solidity" class="language-solidity solidity"><code><span class="token keyword keyword-function">function</span> <span class="token function">virtualUnits</span><span class="token punctuation">(</span><span class="token builtin">address</span> token<span class="token punctuation">)</span> <span class="token keyword keyword-external">external</span> <span class="token keyword keyword-view">view</span> <span class="token keyword keyword-returns">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint256</span><span class="token punctuation">)</span>
</code></pre><ul>
<li><strong>Description</strong>: Returns the required amount of a specific token for the index</li>
<li><strong>Parameters</strong>:
<ul>
<li><code>token</code>: ERC20 token address</li>
</ul>
</li>
<li><strong>Returns</strong>: Amount of tokens required (in base units)</li>
<li><strong>Access</strong>: Public view</li>
<li><strong>Purpose</strong>: Provides real-time token weightings for index composition</li>
<li><strong>Key Aspects</strong>:
<ul>
<li>Returns base units (e.g., wei for ETH)</li>
<li>Used in issuance/redemption calculations</li>
<li>Critical for maintaining index parity</li>
<li>Updated during rebalancing</li>
</ul>
</li>
</ul>
<h5 id="asset-management">Asset Management </h5>
<pre data-role="codeBlock" data-info="solidity" class="language-solidity solidity"><code><span class="token keyword keyword-function">function</span> <span class="token function">invokeERC20s</span><span class="token punctuation">(</span>
    <span class="token builtin">address</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword keyword-calldata">calldata</span> tokens<span class="token punctuation">,</span>
    <span class="token builtin">address</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword keyword-calldata">calldata</span> destinations<span class="token punctuation">,</span>
    <span class="token builtin">uint256</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword keyword-calldata">calldata</span> amounts
<span class="token punctuation">)</span> <span class="token keyword keyword-external">external</span> onlyAuthorized
</code></pre><ul>
<li><strong>Description</strong>: Transfers multiple ERC20 tokens to specified destinations</li>
<li><strong>Parameters</strong>:
<ul>
<li><code>tokens</code>: Array of ERC20 token addresses</li>
<li><code>destinations</code>: Array of recipient addresses</li>
<li><code>amounts</code>: Array of token amounts</li>
</ul>
</li>
<li><strong>Access</strong>: Only authorized addresses (Issuance &amp; InvokeableBounty)</li>
<li><strong>Reverts</strong>: If arrays have different lengths or transfers fail</li>
<li><strong>Security Features</strong>:
<ul>
<li>Multi-token batch processing</li>
<li>Authorized access control</li>
<li>Array length validation</li>
<li>Failed transfer protection</li>
<li>Gas optimization for bulk operations</li>
</ul>
</li>
</ul>
<h6 id="token-operations">Token Operations </h6>
<pre data-role="codeBlock" data-info="solidity" class="language-solidity solidity"><code><span class="token keyword keyword-function">function</span> <span class="token function">invokeMint</span><span class="token punctuation">(</span><span class="token builtin">address</span> to<span class="token punctuation">,</span> <span class="token builtin">uint256</span> amount<span class="token punctuation">)</span> <span class="token keyword keyword-external">external</span> onlyIssuance
</code></pre><ul>
<li><strong>Description</strong>: Mints AMKT tokens</li>
<li><strong>Parameters</strong>:
<ul>
<li><code>to</code>: Recipient address</li>
<li><code>amount</code>: Amount to mint</li>
</ul>
</li>
<li><strong>Access</strong>: Only Issuance contract</li>
<li><strong>Implementation Details</strong>:
<ul>
<li>Restricted to Issuance contract</li>
<li>Maintains supply control</li>
<li>Emits tracking events</li>
<li>Validates recipient address</li>
<li>Ensures sufficient capacity</li>
</ul>
</li>
</ul>
<pre data-role="codeBlock" data-info="solidity" class="language-solidity solidity"><code><span class="token keyword keyword-function">function</span> <span class="token function">invokeBurn</span><span class="token punctuation">(</span><span class="token builtin">address</span> <span class="token keyword keyword-from">from</span><span class="token punctuation">,</span> <span class="token builtin">uint256</span> amount<span class="token punctuation">)</span> <span class="token keyword keyword-external">external</span> onlyIssuance
</code></pre><ul>
<li><strong>Description</strong>: Burns AMKT tokens</li>
<li><strong>Parameters</strong>:
<ul>
<li><code>from</code>: Address to burn from</li>
<li><code>amount</code>: Amount to burn</li>
</ul>
</li>
<li><strong>Access</strong>: Only Issuance contract</li>
<li><strong>Critical Aspects</strong>:
<ul>
<li>Balance verification</li>
<li>Authorization checks</li>
<li>Supply management</li>
<li>Event emission</li>
<li>State consistency</li>
</ul>
</li>
</ul>
<h6 id="fee-management">Fee Management </h6>
<pre data-role="codeBlock" data-info="solidity" class="language-solidity solidity"><code><span class="token keyword keyword-function">function</span> <span class="token function">tryInflation</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword keyword-external">external</span> <span class="token keyword keyword-returns">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint256</span> mintedAmount<span class="token punctuation">)</span>
</code></pre><ul>
<li><strong>Description</strong>: Mints accrued fees and adjusts virtualUnits</li>
<li><strong>Returns</strong>: Amount of tokens minted</li>
<li><strong>Access</strong>: Only fee recipient</li>
<li><strong>Events Emitted</strong>: <code>InflationMinted(uint256 amount)</code></li>
<li><strong>Mechanism</strong>:
<ul>
<li>Calculates accrued fees</li>
<li>Updates virtual units</li>
<li>Mints new tokens</li>
<li>Distributes to recipient</li>
<li>Maintains economic model</li>
</ul>
</li>
</ul>
<h6 id="emergency-controls">Emergency Controls </h6>
<pre data-role="codeBlock" data-info="solidity" class="language-solidity solidity"><code><span class="token keyword keyword-function">function</span> <span class="token function">setEmergency</span><span class="token punctuation">(</span><span class="token builtin">bool</span> state<span class="token punctuation">)</span> <span class="token keyword keyword-external">external</span> onlyEmergencyMultisig
</code></pre><ul>
<li><strong>Description</strong>: Sets emergency state to pause/unpause operations</li>
<li><strong>Parameters</strong>:
<ul>
<li><code>state</code>: Boolean emergency state</li>
</ul>
</li>
<li><strong>Access</strong>: Only emergency multisig</li>
<li><strong>Events Emitted</strong>: <code>EmergencySet(bool state)</code></li>
<li><strong>Safety Features</strong>:
<ul>
<li>Multisig control</li>
<li>Immediate effect</li>
<li>Selective function pausing</li>
<li>Event logging</li>
<li>Recovery procedures</li>
</ul>
</li>
</ul>
<h3 id="issuance-contract">Issuance Contract </h3>
<p><strong>Location</strong>: <code>contracts/src/invoke/Issuance.sol</code></p>
<h4 id="core-functions-1">Core Functions </h4>
<h5 id="token-issuance">Token Issuance </h5>
<pre data-role="codeBlock" data-info="solidity" class="language-solidity solidity"><code><span class="token keyword keyword-function">function</span> <span class="token function">issue</span><span class="token punctuation">(</span><span class="token builtin">uint256</span> amktAmount<span class="token punctuation">,</span> <span class="token builtin">address</span> recipient<span class="token punctuation">)</span> <span class="token keyword keyword-external">external</span> <span class="token keyword keyword-returns">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint256</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword keyword-memory">memory</span><span class="token punctuation">)</span>
</code></pre><ul>
<li><strong>Description</strong>: Issues AMKT tokens in exchange for underlying assets</li>
<li><strong>Parameters</strong>:
<ul>
<li><code>amktAmount</code>: Amount of AMKT to issue</li>
<li><code>recipient</code>: Address to receive AMKT</li>
</ul>
</li>
<li><strong>Returns</strong>: Array of token amounts required</li>
<li><strong>Access</strong>: Public</li>
<li><strong>Events Emitted</strong>: <code>Issue(address indexed recipient, uint256 amount)</code></li>
<li><strong>Process Flow</strong>:
<ul>
<li>Calculates token requirements</li>
<li>Validates balances</li>
<li>Transfers underlying assets</li>
<li>Mints AMKT tokens</li>
<li>Updates state</li>
<li>Emits events</li>
</ul>
</li>
</ul>
<h5 id="token-redemption">Token Redemption </h5>
<pre data-role="codeBlock" data-info="solidity" class="language-solidity solidity"><code><span class="token keyword keyword-function">function</span> <span class="token function">redeem</span><span class="token punctuation">(</span><span class="token builtin">uint256</span> amktAmount<span class="token punctuation">,</span> <span class="token builtin">address</span> recipient<span class="token punctuation">)</span> <span class="token keyword keyword-external">external</span> <span class="token keyword keyword-returns">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint256</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword keyword-memory">memory</span><span class="token punctuation">)</span>
</code></pre><ul>
<li><strong>Description</strong>: Redeems AMKT tokens for underlying assets</li>
<li><strong>Parameters</strong>:
<ul>
<li><code>amktAmount</code>: Amount of AMKT to redeem</li>
<li><code>recipient</code>: Address to receive underlying assets</li>
</ul>
</li>
<li><strong>Returns</strong>: Array of token amounts returned</li>
<li><strong>Access</strong>: Public</li>
<li><strong>Events Emitted</strong>: <code>Redeem(address indexed redeemer, uint256 amount)</code></li>
<li><strong>Execution Steps</strong>:
<ul>
<li>Verifies AMKT balance</li>
<li>Calculates output amounts</li>
<li>Burns AMKT tokens</li>
<li>Transfers underlying assets</li>
<li>Updates protocol state</li>
<li>Generates events</li>
</ul>
</li>
</ul>
<h3 id="invokeable-bounty-contract">InvokeableBounty Contract </h3>
<p><strong>Location</strong>: <code>contracts/src/invoke/Bounty.sol</code></p>
<h4 id="core-functions-2">Core Functions </h4>
<h5 id="bounty-fulfillment">Bounty Fulfillment </h5>
<pre data-role="codeBlock" data-info="solidity" class="language-solidity solidity"><code><span class="token keyword keyword-function">function</span> <span class="token function">fulfillBounty</span><span class="token punctuation">(</span>
    Bounty <span class="token keyword keyword-calldata">calldata</span> bounty<span class="token punctuation">,</span>
    <span class="token builtin">bytes32</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword keyword-calldata">calldata</span> proof
<span class="token punctuation">)</span> <span class="token keyword keyword-external">external</span> onlyFulfiller <span class="token keyword keyword-returns">returns</span> <span class="token punctuation">(</span><span class="token builtin">bool</span><span class="token punctuation">)</span>
</code></pre><ul>
<li><strong>Description</strong>: Executes rebalancing based on provided bounty</li>
<li><strong>Parameters</strong>:
<ul>
<li><code>bounty</code>: Struct containing rebalance parameters</li>
<li><code>proof</code>: Merkle proof validating the bounty</li>
</ul>
</li>
<li><strong>Returns</strong>: Success boolean</li>
<li><strong>Access</strong>: Only authorized fulfiller</li>
<li><strong>Events Emitted</strong>: <code>BountyFulfilled(bytes32 bountyHash)</code></li>
<li><strong>Verification Process</strong>:
<ul>
<li>Validates Merkle proof</li>
<li>Checks deadline</li>
<li>Verifies token addresses</li>
<li>Confirms amounts</li>
<li>Updates virtual units</li>
<li>Executes transfers</li>
</ul>
</li>
</ul>
<h5 id="bounty-struct">Bounty Struct </h5>
<pre data-role="codeBlock" data-info="solidity" class="language-solidity solidity"><code><span class="token keyword keyword-struct">struct</span> <span class="token class-name">Bounty</span> <span class="token punctuation">{</span>
    <span class="token builtin">address</span><span class="token punctuation">[</span><span class="token punctuation">]</span> tokens<span class="token punctuation">;</span>
    <span class="token builtin">uint256</span><span class="token punctuation">[</span><span class="token punctuation">]</span> nominals<span class="token punctuation">;</span>
    <span class="token builtin">uint256</span> deadline<span class="token punctuation">;</span>
    <span class="token builtin">bytes32</span> root<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><ul>
<li><strong>tokens</strong>: Array of token addresses in the index</li>
<li><strong>nominals</strong>: Array of new token amounts</li>
<li><strong>deadline</strong>: Timestamp when bounty expires</li>
<li><strong>root</strong>: Merkle root for validation</li>
<li><strong>Design Considerations</strong>:
<ul>
<li>Gas efficiency</li>
<li>Data integrity</li>
<li>Upgrade compatibility</li>
<li>Security verification</li>
<li>State consistency</li>
</ul>
</li>
</ul>
<h3 id="events">Events </h3>
<h4 id="vault-events">Vault Events </h4>
<pre data-role="codeBlock" data-info="solidity" class="language-solidity solidity"><code><span class="token keyword keyword-event">event</span> <span class="token function">InflationMinted</span><span class="token punctuation">(</span><span class="token builtin">uint256</span> amount<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword keyword-event">event</span> <span class="token function">EmergencySet</span><span class="token punctuation">(</span><span class="token builtin">bool</span> state<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword keyword-event">event</span> <span class="token function">VirtualUnitsSet</span><span class="token punctuation">(</span><span class="token builtin">address</span><span class="token punctuation">[</span><span class="token punctuation">]</span> tokens<span class="token punctuation">,</span> <span class="token builtin">uint256</span><span class="token punctuation">[</span><span class="token punctuation">]</span> amounts<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><ul>
<li><strong>Usage</strong>:
<ul>
<li>Off-chain tracking</li>
<li>State verification</li>
<li>Analytics support</li>
<li>User notifications</li>
<li>Audit trail</li>
</ul>
</li>
</ul>
<h4 id="issuance-events">Issuance Events </h4>
<pre data-role="codeBlock" data-info="solidity" class="language-solidity solidity"><code><span class="token keyword keyword-event">event</span> <span class="token function">Issue</span><span class="token punctuation">(</span><span class="token builtin">address</span> <span class="token keyword keyword-indexed">indexed</span> recipient<span class="token punctuation">,</span> <span class="token builtin">uint256</span> amount<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword keyword-event">event</span> <span class="token function">Redeem</span><span class="token punctuation">(</span><span class="token builtin">address</span> <span class="token keyword keyword-indexed">indexed</span> redeemer<span class="token punctuation">,</span> <span class="token builtin">uint256</span> amount<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><ul>
<li><strong>Monitoring</strong>:
<ul>
<li>Transaction tracking</li>
<li>Volume analysis</li>
<li>User activity</li>
<li>System health</li>
<li>Market dynamics</li>
</ul>
</li>
</ul>
<h4 id="bounty-events">Bounty Events </h4>
<pre data-role="codeBlock" data-info="solidity" class="language-solidity solidity"><code><span class="token keyword keyword-event">event</span> <span class="token function">BountyFulfilled</span><span class="token punctuation">(</span><span class="token builtin">bytes32</span> <span class="token keyword keyword-indexed">indexed</span> bountyHash<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword keyword-event">event</span> <span class="token function">BountySet</span><span class="token punctuation">(</span><span class="token builtin">bytes32</span> <span class="token keyword keyword-indexed">indexed</span> bountyHash<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><ul>
<li><strong>Applications</strong>:
<ul>
<li>Rebalance tracking</li>
<li>Performance monitoring</li>
<li>Historical analysis</li>
<li>System verification</li>
<li>Automation triggers</li>
</ul>
</li>
</ul>
<h3 id="modifiers">Modifiers </h3>
<pre data-role="codeBlock" data-info="solidity" class="language-solidity solidity"><code><span class="token keyword keyword-modifier">modifier</span> <span class="token function">onlyAuthorized</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword keyword-modifier">modifier</span> <span class="token function">onlyIssuance</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword keyword-modifier">modifier</span> <span class="token function">onlyEmergencyMultisig</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword keyword-modifier">modifier</span> <span class="token function">onlyFulfiller</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword keyword-modifier">modifier</span> <span class="token function">nonEmergency</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><h3 id="error-codes">Error Codes </h3>
<pre data-role="codeBlock" data-info="solidity" class="language-solidity solidity"><code>error <span class="token function">Unauthorized</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
error <span class="token function">EmergencyPaused</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
error <span class="token function">InvalidArrayLength</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
error <span class="token function">TransferFailed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
error <span class="token function">InvalidBounty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
error <span class="token function">ExpiredBounty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
error <span class="token function">InvalidProof</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><h3 id="integration-examples">Integration Examples </h3>
<h4 id="issuing-amkt">Issuing AMKT </h4>
<pre data-role="codeBlock" data-info="solidity" class="language-solidity solidity"><code><span class="token comment">// 1. Approve token transfers</span>
<span class="token keyword keyword-for">for</span> <span class="token punctuation">(</span><span class="token builtin">uint</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> tokens<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">IERC20</span><span class="token punctuation">(</span>tokens<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">approve</span><span class="token punctuation">(</span><span class="token builtin">address</span><span class="token punctuation">(</span>issuance<span class="token punctuation">)</span><span class="token punctuation">,</span> amounts<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 2. Issue AMKT</span>
<span class="token builtin">uint256</span> amktAmount <span class="token operator">=</span> <span class="token number">1e18</span><span class="token punctuation">;</span> <span class="token comment">// 1 AMKT</span>
issuance<span class="token punctuation">.</span><span class="token function">issue</span><span class="token punctuation">(</span>amktAmount<span class="token punctuation">,</span> msg<span class="token punctuation">.</span>sender<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><h4 id="redeeming-amkt">Redeeming AMKT </h4>
<pre data-role="codeBlock" data-info="solidity" class="language-solidity solidity"><code><span class="token comment">// 1. Approve AMKT transfer</span>
<span class="token function">IAMKT</span><span class="token punctuation">(</span>amktAddress<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">approve</span><span class="token punctuation">(</span><span class="token builtin">address</span><span class="token punctuation">(</span>issuance<span class="token punctuation">)</span><span class="token punctuation">,</span> amktAmount<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 2. Redeem AMKT</span>
issuance<span class="token punctuation">.</span><span class="token function">redeem</span><span class="token punctuation">(</span>amktAmount<span class="token punctuation">,</span> msg<span class="token punctuation">.</span>sender<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><h3 id="security-considerations">Security Considerations </h3>
<ol>
<li>
<p><strong>Access Control</strong></p>
<ul>
<li>Critical functions are protected by role-based access</li>
<li>Emergency pause mechanism for risk mitigation</li>
<li>Timelocked governance actions</li>
</ul>
</li>
<li>
<p><strong>Input Validation</strong></p>
<ul>
<li>Array length checks</li>
<li>Bounty validation through Merkle proofs</li>
<li>Deadline checks for bounties</li>
</ul>
</li>
<li>
<p><strong>Asset Safety</strong></p>
<ul>
<li>Transfer validations</li>
<li>Fee calculations with overflow protection</li>
<li>Emergency controls cannot block redemptions</li>
</ul>
</li>
<li>
<p><strong>Rebalancing Safety</strong></p>
<ul>
<li>Bounty verification through Merkle proofs</li>
<li>Deadline enforcement</li>
<li>Only authorized fulfiller can execute</li>
</ul>
</li>
</ol>
<h3 id="gas-optimization-notes">Gas Optimization Notes </h3>
<ol>
<li>Use of array-based batch operations for token transfers</li>
<li>Minimal storage operations</li>
<li>Efficient validation checks</li>
<li>Optimized struct packing</li>
</ol>
<h2 id="amkt-v2-rebalance-api-documentation">AMKT v2 Rebalance API Documentation </h2>
<h3 id="overview-2">Overview </h3>
<p>The rebalance system allows for periodic updates to the index composition through a secure, governance-controlled process using the SDK and smart contracts. This process ensures:</p>
<ul>
<li>Transparent and verifiable index updates</li>
<li>Protection against price manipulation</li>
<li>Efficient execution through bounty mechanisms</li>
<li>Multi-layer security checks</li>
</ul>
<h3 id="rebalance-sdk">Rebalance SDK </h3>
<p>The SDK provides programmatic access to rebalancing functionality, enabling automated calculations and proposal generation.</p>
<h4 id="installation">Installation </h4>
<pre data-role="codeBlock" data-info="bash" class="language-bash bash"><code><span class="token builtin class-name">cd</span> sdk/rebalance
<span class="token function">cargo</span> build
</code></pre><h4 id="core-components">Core Components </h4>
<h5 id="1-bounty-structure">1. Bounty Structure </h5>
<p>The bounty system incentivizes efficient index rebalancing while maintaining security:</p>
<pre data-role="codeBlock" data-info="rust" class="language-rust rust"><code><span class="token keyword keyword-pub">pub</span> <span class="token keyword keyword-struct">struct</span> <span class="token type-definition class-name">Bounty</span> <span class="token punctuation">{</span>
    tokens<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">Address</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>    <span class="token comment">// List of token addresses to rebalance</span>
    nominals<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span>u256<span class="token operator">&gt;</span><span class="token punctuation">,</span>     <span class="token comment">// New token quantities after rebalance</span>
    deadline<span class="token punctuation">:</span> u256<span class="token punctuation">,</span>          <span class="token comment">// Timestamp for bounty expiration (prevents stale execution)</span>
    root<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token keyword keyword-u8">u8</span><span class="token punctuation">;</span> <span class="token number">32</span><span class="token punctuation">]</span>          <span class="token comment">// Merkle root for cryptographic validation</span>
<span class="token punctuation">}</span>
</code></pre><h4 id="2-rebalance-configuration">2. Rebalance Configuration </h4>
<p>Configuration parameters that define the rebalance constraints and targets:</p>
<pre data-role="codeBlock" data-info="rust" class="language-rust rust"><code><span class="token keyword keyword-pub">pub</span> <span class="token keyword keyword-struct">struct</span> <span class="token type-definition class-name">RebalanceConfig</span> <span class="token punctuation">{</span>
    target_weights<span class="token punctuation">:</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token class-name">Address</span><span class="token punctuation">,</span> <span class="token class-name">Decimal</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>  <span class="token comment">// Desired portfolio allocation</span>
    current_holdings<span class="token punctuation">:</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token class-name">Address</span><span class="token punctuation">,</span> u256<span class="token operator">&gt;</span><span class="token punctuation">,</span>   <span class="token comment">// Existing token balances</span>
    price_data<span class="token punctuation">:</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token class-name">Address</span><span class="token punctuation">,</span> <span class="token class-name">Decimal</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>      <span class="token comment">// Current market prices</span>
    slippage_tolerance<span class="token punctuation">:</span> <span class="token class-name">Decimal</span>                 <span class="token comment">// Maximum acceptable price impact</span>
<span class="token punctuation">}</span>
</code></pre><h2 id="smart-contract-interface">Smart Contract Interface </h2>
<h3 id="invokeablebounty-contract">InvokeableBounty Contract </h3>
<p>The core contract managing rebalance execution with built-in security checks.</p>
<h4 id="setting-a-new-bounty">Setting a New Bounty </h4>
<pre data-role="codeBlock" data-info="solidity" class="language-solidity solidity"><code><span class="token keyword keyword-function">function</span> <span class="token function">setHash</span><span class="token punctuation">(</span><span class="token builtin">bytes32</span> bountyHash<span class="token punctuation">)</span> <span class="token keyword keyword-external">external</span> onlyGovernance
</code></pre><h4 id="fulfilling-a-bounty">Fulfilling a Bounty </h4>
<pre data-role="codeBlock" data-info="solidity" class="language-solidity solidity"><code><span class="token keyword keyword-function">function</span> <span class="token function">fulfillBounty</span><span class="token punctuation">(</span>
    Bounty <span class="token keyword keyword-calldata">calldata</span> bounty<span class="token punctuation">,</span>
    <span class="token builtin">bytes32</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword keyword-calldata">calldata</span> proof
<span class="token punctuation">)</span> <span class="token keyword keyword-external">external</span> onlyFulfiller <span class="token keyword keyword-returns">returns</span> <span class="token punctuation">(</span><span class="token builtin">bool</span><span class="token punctuation">)</span>
</code></pre><h2 id="rebalance-process">Rebalance Process </h2>
<p>The rebalance workflow consists of three critical phases:</p>
<h3 id="1-preparation-phase">1. Preparation Phase </h3>
<p>Involves careful calculation of required trades while considering:</p>
<ul>
<li>Market depth and liquidity</li>
<li>Price impact</li>
<li>Gas optimization</li>
</ul>
<pre data-role="codeBlock" data-info="rust" class="language-rust rust"><code><span class="token comment">// Example SDK usage for preparing a rebalance</span>
<span class="token keyword keyword-let">let</span> rebalance <span class="token operator">=</span> <span class="token class-name">RebalanceCalculator</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">calculate_required_trades</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">generate_bounty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><h3 id="2-governance-proposal">2. Governance Proposal </h3>
<p>Ensures community oversight and validation of proposed changes:</p>
<pre data-role="codeBlock" data-info="solidity" class="language-solidity solidity"><code><span class="token comment">// Submit bounty through governance with proper checks</span>
<span class="token keyword keyword-function">function</span> <span class="token function">proposeBountyUpdate</span><span class="token punctuation">(</span>
    <span class="token builtin">address</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword keyword-calldata">calldata</span> tokens<span class="token punctuation">,</span>
    <span class="token builtin">uint256</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword keyword-calldata">calldata</span> nominals<span class="token punctuation">,</span>
    <span class="token builtin">uint256</span> deadline<span class="token punctuation">,</span>
    <span class="token builtin">bytes32</span> root
<span class="token punctuation">)</span> <span class="token keyword keyword-external">external</span> <span class="token keyword keyword-returns">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint256</span> proposalId<span class="token punctuation">)</span>
</code></pre><h3 id="3-execution">3. Execution </h3>
<p>Controlled execution by authorized fulfillers with verification:</p>
<pre data-role="codeBlock" data-info="solidity" class="language-solidity solidity"><code><span class="token comment">// After governance approval, fulfiller executes with proof validation</span>
<span class="token keyword keyword-function">function</span> <span class="token function">executeBounty</span><span class="token punctuation">(</span>
    Bounty <span class="token keyword keyword-memory">memory</span> bounty<span class="token punctuation">,</span>
    <span class="token builtin">bytes32</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword keyword-memory">memory</span> proof
<span class="token punctuation">)</span> <span class="token keyword keyword-external">external</span>
</code></pre><h2 id="events">Events </h2>
<pre data-role="codeBlock" data-info="solidity" class="language-solidity solidity"><code><span class="token keyword keyword-event">event</span> <span class="token function">BountySet</span><span class="token punctuation">(</span><span class="token builtin">bytes32</span> <span class="token keyword keyword-indexed">indexed</span> bountyHash<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword keyword-event">event</span> <span class="token function">BountyFulfilled</span><span class="token punctuation">(</span>
    <span class="token builtin">bytes32</span> <span class="token keyword keyword-indexed">indexed</span> bountyHash<span class="token punctuation">,</span>
    <span class="token builtin">address</span> <span class="token keyword keyword-indexed">indexed</span> fulfiller
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><h2 id="error-codes-1">Error Codes </h2>
<pre data-role="codeBlock" data-info="solidity" class="language-solidity solidity"><code>error <span class="token function">InvalidBounty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
error <span class="token function">ExpiredBounty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
error <span class="token function">InvalidProof</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
error <span class="token function">UnauthorizedFulfiller</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><h2 id="usage-examples">Usage Examples </h2>
<h3 id="1-calculate-rebalance-requirements">1. Calculate Rebalance Requirements </h3>
<pre data-role="codeBlock" data-info="rust" class="language-rust rust"><code><span class="token keyword keyword-use">use</span> <span class="token namespace">amkt_sdk<span class="token punctuation">::</span>rebalance<span class="token punctuation">::</span></span><span class="token punctuation">{</span><span class="token class-name">RebalanceCalculator</span><span class="token punctuation">,</span> <span class="token class-name">Config</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword keyword-fn">fn</span> <span class="token function-definition function">prepare_rebalance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Bounty</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-let">let</span> config <span class="token operator">=</span> <span class="token class-name">Config</span> <span class="token punctuation">{</span>
        target_weights<span class="token punctuation">:</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span>
            <span class="token punctuation">(</span>token_a<span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">(</span>token_b<span class="token punctuation">,</span> <span class="token number">0.3</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">(</span>token_c<span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">)</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
        slippage_tolerance<span class="token punctuation">:</span> <span class="token number">0.01</span><span class="token punctuation">,</span>
        <span class="token comment">// ... other config</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token class-name">RebalanceCalculator</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">calculate_required_trades</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">generate_bounty</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><h3 id="2-submit-rebalance-proposal">2. Submit Rebalance Proposal </h3>
<pre data-role="codeBlock" data-info="typescript" class="language-typescript typescript"><code><span class="token comment">// Example using ethers.js</span>
<span class="token keyword keyword-async">async</span> <span class="token keyword keyword-function">function</span> <span class="token function">submitRebalanceProposal</span><span class="token punctuation">(</span>bounty<span class="token operator">:</span> Bounty<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-const">const</span> proposal <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> governance<span class="token punctuation">.</span><span class="token function">propose</span><span class="token punctuation">(</span>
        <span class="token punctuation">[</span>bounty<span class="token punctuation">.</span>address<span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">[</span>bounty<span class="token punctuation">.</span>calldata<span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token string">"Monthly Index Rebalance"</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-return">return</span> proposal<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><h3 id="3-execute-rebalance">3. Execute Rebalance </h3>
<pre data-role="codeBlock" data-info="solidity" class="language-solidity solidity"><code><span class="token comment">// Example fulfiller implementation</span>
<span class="token keyword keyword-function">function</span> <span class="token function">executeRebalance</span><span class="token punctuation">(</span>
    Bounty <span class="token keyword keyword-calldata">calldata</span> bounty<span class="token punctuation">,</span>
    <span class="token builtin">bytes32</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword keyword-calldata">calldata</span> proof
<span class="token punctuation">)</span> <span class="token keyword keyword-external">external</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-require">require</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender <span class="token operator">==</span> fulfiller<span class="token punctuation">,</span> <span class="token string">"Unauthorized"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    bountyContract<span class="token punctuation">.</span><span class="token function">fulfillBounty</span><span class="token punctuation">(</span>bounty<span class="token punctuation">,</span> proof<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><h2 id="security-considerations">Security Considerations </h2>
<ol>
<li>
<p><strong>Validation Checks</strong></p>
<ul>
<li>Merkle proof verification ensures data integrity</li>
<li>Deadline enforcement prevents stale execution</li>
<li>Slippage protection guards against price manipulation</li>
</ul>
</li>
<li>
<p><strong>Access Control</strong></p>
<ul>
<li>Governance-controlled bounty setting prevents unauthorized changes</li>
<li>Restricted fulfiller access ensures proper execution</li>
<li>Timelock delays allow community review</li>
</ul>
</li>
<li>
<p><strong>Economic Security</strong></p>
<ul>
<li>Maximum weight changes prevent dramatic shifts</li>
<li>Price impact limits protect against market manipulation</li>
<li>Token whitelist ensures index quality</li>
</ul>
</li>
</ol>
<h2 id="best-practices">Best Practices </h2>
<ol>
<li><strong>Pre-execution Validation</strong></li>
</ol>
<pre data-role="codeBlock" data-info="rust" class="language-rust rust"><code><span class="token keyword keyword-fn">fn</span> <span class="token function-definition function">validate_rebalance</span><span class="token punctuation">(</span>bounty<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">Bounty</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Error</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// Verify token addresses</span>
    <span class="token comment">// Check weight constraints</span>
    <span class="token comment">// Validate price impact</span>
    <span class="token comment">// Ensure sufficient liquidity</span>
<span class="token punctuation">}</span>
</code></pre><ol start="2">
<li><strong>Monitoring</strong></li>
</ol>
<pre data-role="codeBlock" data-info="rust" class="language-rust rust"><code><span class="token keyword keyword-fn">fn</span> <span class="token function-definition function">monitor_execution</span><span class="token punctuation">(</span>tx_hash<span class="token punctuation">:</span> <span class="token constant">H256</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Error</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// Track transaction status</span>
    <span class="token comment">// Monitor price impact</span>
    <span class="token comment">// Log execution details</span>
<span class="token punctuation">}</span>
</code></pre><ol start="3">
<li><strong>Emergency Procedures</strong></li>
</ol>
<pre data-role="codeBlock" data-info="solidity" class="language-solidity solidity"><code><span class="token comment">// Emergency pause if needed</span>
<span class="token keyword keyword-function">function</span> <span class="token function">emergencyPause</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword keyword-external">external</span> onlyEmergencyMultisig <span class="token punctuation">{</span>
    vault<span class="token punctuation">.</span><span class="token function">setEmergency</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><h2 id="governance-api">Governance API </h2>
<h3 id="governance-overview">Overview </h3>
<p>The AMKT governance system enables decentralized control over the index through a combination of token voting, time-locked execution, and multi-sig security measures. This multi-layered approach ensures:</p>
<ul>
<li>Transparent and democratic decision-making through token-weighted voting</li>
<li>Protection against malicious proposals via timelock delays</li>
<li>Emergency safeguards through multi-signature controls</li>
</ul>
<h3 id="governance-components">Core Components </h3>
<h4 id="timelock-controller">TimelockController </h4>
<pre data-role="codeBlock" data-info="solidity" class="language-solidity solidity"><code><span class="token keyword keyword-contract">contract</span> <span class="token class-name">TimelockController</span> <span class="token keyword keyword-is">is</span> ITimelockController
</code></pre><h5 id="key-parameters">Key Parameters </h5>
<ul>
<li>Minimum Delay: 4 days</li>
<li>Proposers: Governance contract</li>
<li>Executors: Governance Multisig</li>
<li>Admin: Governance Multisig</li>
</ul>
<h5 id="core-functions-3">Core Functions </h5>
<pre data-role="codeBlock" data-info="solidity" class="language-solidity solidity"><code><span class="token keyword keyword-function">function</span> <span class="token function">schedule</span><span class="token punctuation">(</span>
    <span class="token builtin">address</span> target<span class="token punctuation">,</span>
    <span class="token builtin">uint256</span> value<span class="token punctuation">,</span>
    <span class="token builtin">bytes</span> <span class="token keyword keyword-calldata">calldata</span> data<span class="token punctuation">,</span>
    <span class="token builtin">bytes32</span> predecessor<span class="token punctuation">,</span>
    <span class="token builtin">bytes32</span> salt<span class="token punctuation">,</span>
    <span class="token builtin">uint256</span> delay
<span class="token punctuation">)</span> <span class="token keyword keyword-external">external</span><span class="token punctuation">;</span>

<span class="token keyword keyword-function">function</span> <span class="token function">execute</span><span class="token punctuation">(</span>
    <span class="token builtin">address</span> target<span class="token punctuation">,</span>
    <span class="token builtin">uint256</span> value<span class="token punctuation">,</span>
    <span class="token builtin">bytes</span> <span class="token keyword keyword-calldata">calldata</span> data<span class="token punctuation">,</span>
    <span class="token builtin">bytes32</span> predecessor<span class="token punctuation">,</span>
    <span class="token builtin">bytes32</span> salt
<span class="token punctuation">)</span> <span class="token keyword keyword-external">external</span> <span class="token keyword keyword-payable">payable</span><span class="token punctuation">;</span>

<span class="token keyword keyword-function">function</span> <span class="token function">cancel</span><span class="token punctuation">(</span><span class="token builtin">bytes32</span> id<span class="token punctuation">)</span> <span class="token keyword keyword-external">external</span><span class="token punctuation">;</span>
</code></pre><h4 id="governance-contract">Governance Contract </h4>
<p>The governance contract serves as the primary interface for proposal creation and voting. It implements a time-based voting system with the following carefully balanced parameters:</p>
<h5 id="voting-parameters">Voting Parameters </h5>
<ul>
<li>Voting Delay: 1 block (~12 seconds) to ensure proposal visibility</li>
<li>Voting Period: 3 days to allow sufficient community participation</li>
<li>Proposal Threshold: 1% of total supply to prevent spam while maintaining accessibility</li>
<li>Quorum: 4% of total supply to ensure meaningful consensus</li>
</ul>
<h4 id="key-functions">Key Functions </h4>
<pre data-role="codeBlock" data-info="solidity" class="language-solidity solidity"><code><span class="token keyword keyword-function">function</span> <span class="token function">propose</span><span class="token punctuation">(</span>
    <span class="token builtin">address</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword keyword-memory">memory</span> targets<span class="token punctuation">,</span>
    <span class="token builtin">uint256</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword keyword-memory">memory</span> values<span class="token punctuation">,</span>
    <span class="token builtin">bytes</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword keyword-memory">memory</span> calldatas<span class="token punctuation">,</span>
    <span class="token builtin">string</span> <span class="token keyword keyword-memory">memory</span> description
<span class="token punctuation">)</span> <span class="token keyword keyword-external">external</span> <span class="token keyword keyword-returns">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint256</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword keyword-function">function</span> <span class="token function">castVote</span><span class="token punctuation">(</span><span class="token builtin">uint256</span> proposalId<span class="token punctuation">,</span> <span class="token builtin">uint8</span> support<span class="token punctuation">)</span> <span class="token keyword keyword-external">external</span> <span class="token keyword keyword-returns">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint256</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword keyword-function">function</span> <span class="token function">castVoteWithReason</span><span class="token punctuation">(</span>
    <span class="token builtin">uint256</span> proposalId<span class="token punctuation">,</span>
    <span class="token builtin">uint8</span> support<span class="token punctuation">,</span>
    <span class="token builtin">string</span> <span class="token keyword keyword-calldata">calldata</span> reason
<span class="token punctuation">)</span> <span class="token keyword keyword-external">external</span> <span class="token keyword keyword-returns">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint256</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><h3 id="governance-actions">Governance Actions </h3>
<p>Governance can execute various system-critical operations, each requiring proper authorization and timelock delays:</p>
<h4 id="rebalance-process">Rebalance Process </h4>
<p>The rebalancing mechanism allows for index composition updates through a structured process:</p>
<ol>
<li>
<p>Community proposal of new weights</p>
</li>
<li>
<p>Token holder voting</p>
</li>
<li>
<p>Timelock delay</p>
</li>
<li>
<p>Multisig execution</p>
</li>
<li>
<p><strong>Submit Bounty</strong></p>
</li>
</ol>
<pre data-role="codeBlock" data-info="solidity" class="language-solidity solidity"><code><span class="token keyword keyword-function">function</span> <span class="token function">submitBounty</span><span class="token punctuation">(</span>
    <span class="token builtin">address</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword keyword-calldata">calldata</span> tokens<span class="token punctuation">,</span>
    <span class="token builtin">uint256</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword keyword-calldata">calldata</span> nominals<span class="token punctuation">,</span>
    <span class="token builtin">uint256</span> deadline<span class="token punctuation">,</span>
    <span class="token builtin">bytes32</span> root
<span class="token punctuation">)</span> <span class="token keyword keyword-external">external</span><span class="token punctuation">;</span>
</code></pre><h3 id="vault-configuration">Vault Configuration </h3>
<ol>
<li><strong>Update Fee Rate</strong></li>
</ol>
<pre data-role="codeBlock" data-info="solidity" class="language-solidity solidity"><code><span class="token keyword keyword-function">function</span> <span class="token function">setFeeRate</span><span class="token punctuation">(</span><span class="token builtin">uint256</span> newRate<span class="token punctuation">)</span> <span class="token keyword keyword-external">external</span><span class="token punctuation">;</span>
</code></pre><ol start="2">
<li><strong>Update Fee Recipient</strong></li>
</ol>
<pre data-role="codeBlock" data-info="solidity" class="language-solidity solidity"><code><span class="token keyword keyword-function">function</span> <span class="token function">setFeeRecipient</span><span class="token punctuation">(</span><span class="token builtin">address</span> newRecipient<span class="token punctuation">)</span> <span class="token keyword keyword-external">external</span><span class="token punctuation">;</span>
</code></pre><h3 id="role-management">Role Management </h3>
<pre data-role="codeBlock" data-info="solidity" class="language-solidity solidity"><code><span class="token keyword keyword-function">function</span> <span class="token function">grantRole</span><span class="token punctuation">(</span><span class="token builtin">bytes32</span> role<span class="token punctuation">,</span> <span class="token builtin">address</span> account<span class="token punctuation">)</span> <span class="token keyword keyword-external">external</span><span class="token punctuation">;</span>
<span class="token keyword keyword-function">function</span> <span class="token function">revokeRole</span><span class="token punctuation">(</span><span class="token builtin">bytes32</span> role<span class="token punctuation">,</span> <span class="token builtin">address</span> account<span class="token punctuation">)</span> <span class="token keyword keyword-external">external</span><span class="token punctuation">;</span>
</code></pre><h3 id="security-measures">Security Measures </h3>
<p>The system implements multiple security layers to protect against various attack vectors:</p>
<h4 id="governance-multisig">Governance Multisig </h4>
<p>A group of trusted entities that provide an additional security layer with:</p>
<h5 id="capabilities">Capabilities </h5>
<ul>
<li>Execute timelocked transactions after community approval</li>
<li>Cancel malicious proposals before execution</li>
<li>Emergency pause functionality for critical situations</li>
<li>Ability to upgrade contracts through careful deliberation</li>
</ul>
<pre data-role="codeBlock" data-info="solidity" class="language-solidity solidity"><code><span class="token keyword keyword-function">function</span> <span class="token function">setEmergency</span><span class="token punctuation">(</span><span class="token builtin">bool</span> state<span class="token punctuation">)</span> <span class="token keyword keyword-external">external</span> onlyEmergencyMultisig<span class="token punctuation">;</span>
</code></pre><h3 id="participation-guide">Participation Guide </h3>
<p>A comprehensive guide to engaging with AMKT governance:</p>
<h4 id="1-token-voting">1. Token Voting </h4>
<p>Users can participate through multiple mechanisms:</p>
<ul>
<li>Direct voting on Tally (recommended for most users)</li>
<li>Delegation to expert voters or DAOs</li>
<li>Self-custody voting through direct contract interaction</li>
</ul>
<pre data-role="codeBlock" data-info="solidity" class="language-solidity solidity"><code><span class="token keyword keyword-function">function</span> <span class="token function">delegate</span><span class="token punctuation">(</span><span class="token builtin">address</span> delegatee<span class="token punctuation">)</span> <span class="token keyword keyword-external">external</span><span class="token punctuation">;</span>
<span class="token keyword keyword-function">function</span> <span class="token function">delegateBySig</span><span class="token punctuation">(</span>
    <span class="token builtin">address</span> delegatee<span class="token punctuation">,</span>
    <span class="token builtin">uint256</span> nonce<span class="token punctuation">,</span>
    <span class="token builtin">uint256</span> expiry<span class="token punctuation">,</span>
    <span class="token builtin">uint8</span> v<span class="token punctuation">,</span>
    <span class="token builtin">bytes32</span> r<span class="token punctuation">,</span>
    <span class="token builtin">bytes32</span> s
<span class="token punctuation">)</span> <span class="token keyword keyword-external">external</span><span class="token punctuation">;</span>
</code></pre><h3 id="2-proposal-creation">2. Proposal Creation </h3>
<p>Requirements:</p>
<ul>
<li>Must hold or be delegated &gt;= 1% of total supply</li>
<li>Proposals must be executable actions</li>
</ul>
<h3 id="3-voting-process">3. Voting Process </h3>
<ol>
<li>Proposal Creation</li>
<li>Voting Delay (1 block)</li>
<li>Voting Period (3 days)</li>
<li>Timelock Delay (4 days)</li>
<li>Execution by Multisig</li>
</ol>
<h3 id="governance-events">Events </h3>
<pre data-role="codeBlock" data-info="solidity" class="language-solidity solidity"><code><span class="token keyword keyword-event">event</span> <span class="token function">ProposalCreated</span><span class="token punctuation">(</span>
    <span class="token builtin">uint256</span> proposalId<span class="token punctuation">,</span>
    <span class="token builtin">address</span> proposer<span class="token punctuation">,</span>
    <span class="token builtin">address</span><span class="token punctuation">[</span><span class="token punctuation">]</span> targets<span class="token punctuation">,</span>
    <span class="token builtin">uint256</span><span class="token punctuation">[</span><span class="token punctuation">]</span> values<span class="token punctuation">,</span>
    <span class="token builtin">bytes</span><span class="token punctuation">[</span><span class="token punctuation">]</span> calldatas<span class="token punctuation">,</span>
    <span class="token builtin">string</span> description
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword keyword-event">event</span> <span class="token function">VoteCast</span><span class="token punctuation">(</span>
    <span class="token builtin">address</span> <span class="token keyword keyword-indexed">indexed</span> voter<span class="token punctuation">,</span>
    <span class="token builtin">uint256</span> proposalId<span class="token punctuation">,</span>
    <span class="token builtin">uint8</span> support<span class="token punctuation">,</span>
    <span class="token builtin">uint256</span> weight<span class="token punctuation">,</span>
    <span class="token builtin">string</span> reason
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword keyword-event">event</span> <span class="token function">ProposalExecuted</span><span class="token punctuation">(</span><span class="token builtin">uint256</span> proposalId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword keyword-event">event</span> <span class="token function">ProposalCanceled</span><span class="token punctuation">(</span><span class="token builtin">uint256</span> proposalId<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><h2 id="integration-examples-1">Integration Examples </h2>
<h3 id="creating-a-proposal">Creating a Proposal </h3>
<pre data-role="codeBlock" data-info="solidity" class="language-solidity solidity"><code><span class="token comment">// Example: Create a proposal to update fee rate</span>
<span class="token keyword keyword-function">function</span> <span class="token function">createFeeUpdateProposal</span><span class="token punctuation">(</span><span class="token builtin">uint256</span> newFeeRate<span class="token punctuation">)</span> <span class="token keyword keyword-external">external</span> <span class="token punctuation">{</span>
    <span class="token builtin">address</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword keyword-memory">memory</span> targets <span class="token operator">=</span> <span class="token keyword keyword-new">new</span> <span class="token class-name">address</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    targets<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token builtin">address</span><span class="token punctuation">(</span>vault<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token builtin">uint256</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword keyword-memory">memory</span> values <span class="token operator">=</span> <span class="token keyword keyword-new">new</span> <span class="token class-name">uint256</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    values<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    
    <span class="token builtin">bytes</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword keyword-memory">memory</span> calldatas <span class="token operator">=</span> <span class="token keyword keyword-new">new</span> <span class="token class-name">bytes</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    calldatas<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> abi<span class="token punctuation">.</span><span class="token function">encodeWithSignature</span><span class="token punctuation">(</span><span class="token string">"setFeeRate(uint256)"</span><span class="token punctuation">,</span> newFeeRate<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token builtin">string</span> <span class="token keyword keyword-memory">memory</span> description <span class="token operator">=</span> <span class="token string">"Update fee rate proposal"</span><span class="token punctuation">;</span>
    
    governance<span class="token punctuation">.</span><span class="token function">propose</span><span class="token punctuation">(</span>targets<span class="token punctuation">,</span> values<span class="token punctuation">,</span> calldatas<span class="token punctuation">,</span> description<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><h3 id="voting-on-a-proposal">Voting on a Proposal </h3>
<pre data-role="codeBlock" data-info="solidity" class="language-solidity solidity"><code><span class="token comment">// Cast a vote</span>
<span class="token keyword keyword-function">function</span> <span class="token function">vote</span><span class="token punctuation">(</span><span class="token builtin">uint256</span> proposalId<span class="token punctuation">,</span> <span class="token builtin">bool</span> support<span class="token punctuation">)</span> <span class="token keyword keyword-external">external</span> <span class="token punctuation">{</span>
    governance<span class="token punctuation">.</span><span class="token function">castVote</span><span class="token punctuation">(</span>proposalId<span class="token punctuation">,</span> support <span class="token operator">?</span> <span class="token number">1</span> <span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// Cast a vote with reason</span>
<span class="token keyword keyword-function">function</span> <span class="token function">voteWithReason</span><span class="token punctuation">(</span><span class="token builtin">uint256</span> proposalId<span class="token punctuation">,</span> <span class="token builtin">bool</span> support<span class="token punctuation">,</span> <span class="token builtin">string</span> <span class="token keyword keyword-memory">memory</span> reason<span class="token punctuation">)</span> <span class="token keyword keyword-external">external</span> <span class="token punctuation">{</span>
    governance<span class="token punctuation">.</span><span class="token function">castVoteWithReason</span><span class="token punctuation">(</span>proposalId<span class="token punctuation">,</span> support <span class="token operator">?</span> <span class="token number">1</span> <span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> reason<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><h2 id="error-codes-2">Error Codes </h2>
<pre data-role="codeBlock" data-info="solidity" class="language-solidity solidity"><code>error <span class="token function">InsufficientVotingPower</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
error <span class="token function">ProposalNotActive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
error <span class="token function">InvalidProposalState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
error <span class="token function">TimelockNotExpired</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
error <span class="token function">UnauthorizedExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><h2 id="events-api-documentation">Events API Documentation </h2>
<h3 id="overview-3">Overview </h3>
<p>AMKT v2's event system provides:</p>
<ul>
<li>Real-time state change notifications</li>
<li>Historical data tracking</li>
<li>Integration points for external systems</li>
<li>Audit trail capabilities</li>
<li>Indexing support for dApps</li>
</ul>
<h3 id="core-events">Core Events </h3>
<h4 id="vault-events-1">Vault Events </h4>
<h5 id="tokensdeposited">TokensDeposited </h5>
<p>Emitted when tokens are added to the vault.</p>
<pre data-role="codeBlock" data-info="solidity" class="language-solidity solidity"><code><span class="token keyword keyword-event">event</span> <span class="token function">TokensDeposited</span><span class="token punctuation">(</span>
    <span class="token builtin">address</span> <span class="token keyword keyword-indexed">indexed</span> depositor<span class="token punctuation">,</span>
    <span class="token builtin">address</span><span class="token punctuation">[</span><span class="token punctuation">]</span> tokens<span class="token punctuation">,</span>
    <span class="token builtin">uint256</span><span class="token punctuation">[</span><span class="token punctuation">]</span> amounts<span class="token punctuation">,</span>
    <span class="token builtin">uint256</span> <span class="token keyword keyword-indexed">indexed</span> timestamp
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p><strong>Use Cases</strong>:</p>
<ul>
<li>Track deposit volumes</li>
<li>Monitor user activity</li>
<li>Calculate TVL changes</li>
<li>Analyze token flows</li>
<li>Trigger notifications</li>
</ul>
<h5 id="tokenswithdrawn">TokensWithdrawn </h5>
<p>Emitted during token withdrawal operations.</p>
<pre data-role="codeBlock" data-info="solidity" class="language-solidity solidity"><code><span class="token keyword keyword-event">event</span> <span class="token function">TokensWithdrawn</span><span class="token punctuation">(</span>
    <span class="token builtin">address</span> <span class="token keyword keyword-indexed">indexed</span> withdrawer<span class="token punctuation">,</span>
    <span class="token builtin">address</span><span class="token punctuation">[</span><span class="token punctuation">]</span> tokens<span class="token punctuation">,</span>
    <span class="token builtin">uint256</span><span class="token punctuation">[</span><span class="token punctuation">]</span> amounts<span class="token punctuation">,</span>
    <span class="token builtin">uint256</span> <span class="token keyword keyword-indexed">indexed</span> timestamp
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p><strong>Applications</strong>:</p>
<ul>
<li>Monitor outflows</li>
<li>Track user exits</li>
<li>Calculate redemption rates</li>
<li>Risk assessment</li>
<li>Portfolio tracking</li>
</ul>
<h4 id="rebalance-events">Rebalance Events </h4>
<h5 id="rebalanceinitiated">RebalanceInitiated </h5>
<p>Signals the start of a rebalancing process.</p>
<pre data-role="codeBlock" data-info="solidity" class="language-solidity solidity"><code><span class="token keyword keyword-event">event</span> <span class="token function">RebalanceInitiated</span><span class="token punctuation">(</span>
    <span class="token builtin">bytes32</span> <span class="token keyword keyword-indexed">indexed</span> bountyHash<span class="token punctuation">,</span>
    <span class="token builtin">uint256</span> <span class="token keyword keyword-indexed">indexed</span> deadline<span class="token punctuation">,</span>
    <span class="token builtin">address</span> initiator
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p><strong>Monitoring Aspects</strong>:</p>
<ul>
<li>Track rebalance frequency</li>
<li>Measure completion times</li>
<li>Monitor initiator patterns</li>
<li>Analyze deadline settings</li>
<li>Gauge market impact</li>
</ul>
<h5 id="rebalancecompleted">RebalanceCompleted </h5>
<p>Marks successful completion of rebalancing.</p>
<pre data-role="codeBlock" data-info="solidity" class="language-solidity solidity"><code><span class="token keyword keyword-event">event</span> <span class="token function">RebalanceCompleted</span><span class="token punctuation">(</span>
    <span class="token builtin">bytes32</span> <span class="token keyword keyword-indexed">indexed</span> bountyHash<span class="token punctuation">,</span>
    <span class="token builtin">address</span> <span class="token keyword keyword-indexed">indexed</span> fulfiller<span class="token punctuation">,</span>
    <span class="token builtin">uint256</span> executionTime
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p><strong>Analysis Points</strong>:</p>
<ul>
<li>Execution efficiency</li>
<li>Fulfiller performance</li>
<li>Time to completion</li>
<li>Success rates</li>
<li>Gas optimization</li>
</ul>
<h4 id="governance-events">Governance Events </h4>
<h5 id="proposalcreated">ProposalCreated </h5>
<p>Emitted when new governance proposals are submitted.</p>
<pre data-role="codeBlock" data-info="solidity" class="language-solidity solidity"><code><span class="token keyword keyword-event">event</span> <span class="token function">ProposalCreated</span><span class="token punctuation">(</span>
    <span class="token builtin">uint256</span> <span class="token keyword keyword-indexed">indexed</span> proposalId<span class="token punctuation">,</span>
    <span class="token builtin">address</span> <span class="token keyword keyword-indexed">indexed</span> proposer<span class="token punctuation">,</span>
    <span class="token builtin">string</span> description<span class="token punctuation">,</span>
    <span class="token builtin">uint256</span> startBlock<span class="token punctuation">,</span>
    <span class="token builtin">uint256</span> endBlock
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p><strong>Governance Tracking</strong>:</p>
<ul>
<li>Proposal activity</li>
<li>Proposer analysis</li>
<li>Voting periods</li>
<li>Community engagement</li>
<li>Governance trends</li>
</ul>
<h5 id="proposalexecuted">ProposalExecuted </h5>
<p>Signals successful proposal execution.</p>
<pre data-role="codeBlock" data-info="solidity" class="language-solidity solidity"><code><span class="token keyword keyword-event">event</span> <span class="token function">ProposalExecuted</span><span class="token punctuation">(</span>
    <span class="token builtin">uint256</span> <span class="token keyword keyword-indexed">indexed</span> proposalId<span class="token punctuation">,</span>
    <span class="token builtin">address</span> <span class="token keyword keyword-indexed">indexed</span> executor<span class="token punctuation">,</span>
    <span class="token builtin">uint256</span> timestamp
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p><strong>Implementation Metrics</strong>:</p>
<ul>
<li>Execution success rates</li>
<li>Time to execution</li>
<li>Executor patterns</li>
<li>Governance efficiency</li>
<li>Impact analysis</li>
</ul>
<h3 id="emergency-events">Emergency Events </h3>
<h5 id="emergencypaused">EmergencyPaused </h5>
<p>Indicates activation of emergency pause.</p>
<pre data-role="codeBlock" data-info="solidity" class="language-solidity solidity"><code><span class="token keyword keyword-event">event</span> <span class="token function">EmergencyPaused</span><span class="token punctuation">(</span>
    <span class="token builtin">address</span> <span class="token keyword keyword-indexed">indexed</span> triggeredBy<span class="token punctuation">,</span>
    <span class="token builtin">uint256</span> timestamp<span class="token punctuation">,</span>
    <span class="token builtin">string</span> reason
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p><strong>Security Monitoring</strong>:</p>
<ul>
<li>Incident tracking</li>
<li>Response times</li>
<li>Risk patterns</li>
<li>System health</li>
<li>Recovery planning</li>
</ul>
<h5 id="emergencyunpaused">EmergencyUnpaused </h5>
<p>Signals system resumption after pause.</p>
<pre data-role="codeBlock" data-info="solidity" class="language-solidity solidity"><code><span class="token keyword keyword-event">event</span> <span class="token function">EmergencyUnpaused</span><span class="token punctuation">(</span>
    <span class="token builtin">address</span> <span class="token keyword keyword-indexed">indexed</span> triggeredBy<span class="token punctuation">,</span>
    <span class="token builtin">uint256</span> timestamp
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p><strong>Recovery Metrics</strong>:</p>
<ul>
<li>Downtime duration</li>
<li>Resolution speed</li>
<li>System stability</li>
<li>Recovery patterns</li>
<li>Impact assessment</li>
</ul>
<h3 id="usage-examples-1">Usage Examples </h3>
<h4 id="listening-for-events-web3js">Listening for Events (Web3.js) </h4>
<pre data-role="codeBlock" data-info="typescript" class="language-typescript typescript"><code><span class="token comment">// Listen for deposit events</span>
vault<span class="token punctuation">.</span>events<span class="token punctuation">.</span><span class="token function">TokensDeposited</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    fromBlock<span class="token operator">:</span> <span class="token string">'latest'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span> <span class="token keyword keyword-async">async</span> <span class="token punctuation">(</span>event<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-const">const</span> <span class="token punctuation">{</span>
        depositor<span class="token punctuation">,</span>
        tokens<span class="token punctuation">,</span>
        amounts<span class="token punctuation">,</span>
        timestamp
    <span class="token punctuation">}</span> <span class="token operator">=</span> event<span class="token punctuation">.</span>returnValues<span class="token punctuation">;</span>
    
    <span class="token comment">// Handle deposit event</span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">New deposit from </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>depositor<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><h4 id="querying-historical-events-ethersjs">Querying Historical Events (Ethers.js) </h4>
<pre data-role="codeBlock" data-info="typescript" class="language-typescript typescript"><code><span class="token keyword keyword-async">async</span> <span class="token keyword keyword-function">function</span> <span class="token function">getRebalanceHistory</span><span class="token punctuation">(</span>fromBlock<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span> toBlock<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-const">const</span> filter <span class="token operator">=</span> vault<span class="token punctuation">.</span>filters<span class="token punctuation">.</span><span class="token function">RebalanceCompleted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-const">const</span> events <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> vault<span class="token punctuation">.</span><span class="token function">queryFilter</span><span class="token punctuation">(</span>filter<span class="token punctuation">,</span> fromBlock<span class="token punctuation">,</span> toBlock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword keyword-return">return</span> events<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>event <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
        bountyHash<span class="token operator">:</span> event<span class="token punctuation">.</span>args<span class="token punctuation">.</span>bountyHash<span class="token punctuation">,</span>
        fulfiller<span class="token operator">:</span> event<span class="token punctuation">.</span>args<span class="token punctuation">.</span>fulfiller<span class="token punctuation">,</span>
        executionTime<span class="token operator">:</span> event<span class="token punctuation">.</span>args<span class="token punctuation">.</span>executionTime
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><h3 id="event-monitoring-best-practices">Event Monitoring Best Practices </h3>
<ol>
<li><strong>Error Handling</strong></li>
</ol>
<pre data-role="codeBlock" data-info="typescript" class="language-typescript typescript"><code>vault<span class="token punctuation">.</span>events<span class="token punctuation">.</span><span class="token function">TokensDeposited</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'Event error:'</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// Implement retry logic</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'connected'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>subscriptionId<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Subscription successful:'</span><span class="token punctuation">,</span> subscriptionId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><ol start="2">
<li><strong>Event Confirmation</strong></li>
</ol>
<pre data-role="codeBlock" data-info="typescript" class="language-typescript typescript"><code><span class="token keyword keyword-async">async</span> <span class="token keyword keyword-function">function</span> <span class="token function">waitForEventConfirmation</span><span class="token punctuation">(</span>txHash<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> confirmations<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-const">const</span> receipt <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> web3<span class="token punctuation">.</span>eth<span class="token punctuation">.</span><span class="token function">getTransactionReceipt</span><span class="token punctuation">(</span>txHash<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-const">const</span> currentBlock <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> web3<span class="token punctuation">.</span>eth<span class="token punctuation">.</span><span class="token function">getBlockNumber</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword keyword-return">return</span> currentBlock <span class="token operator">-</span> receipt<span class="token punctuation">.</span>blockNumber <span class="token operator">&gt;=</span> confirmations<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><ol start="3">
<li><strong>Event Aggregation</strong></li>
</ol>
<pre data-role="codeBlock" data-info="typescript" class="language-typescript typescript"><code><span class="token keyword keyword-interface">interface</span> <span class="token class-name">EventAggregator</span> <span class="token punctuation">{</span>
    deposits<span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token punctuation">[</span>address<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            tokens<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            amounts<span class="token operator">:</span> BigNumber<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            timestamp<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    rebalances<span class="token operator">:</span> <span class="token punctuation">{</span>
        bountyHash<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
        fulfiller<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
        executionTime<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><h3 id="security-considerations-1">Security Considerations </h3>
<ol>
<li>
<p><strong>Event Verification</strong></p>
<ul>
<li>Signature validation</li>
<li>Parameter bounds checking</li>
<li>Source contract verification</li>
<li>Timestamp validation</li>
<li>Data integrity checks</li>
</ul>
</li>
<li>
<p><strong>Reorg Handling</strong></p>
<ul>
<li>Chain reorganization detection</li>
<li>Event confirmation tracking</li>
<li>State reconciliation</li>
<li>Data consistency</li>
<li>Recovery procedures</li>
</ul>
</li>
<li>
<p><strong>Rate Limiting</strong></p>
<ul>
<li>Request throttling</li>
<li>Caching strategies</li>
<li>Batch processing</li>
<li>Resource management</li>
<li>Performance optimization</li>
</ul>
</li>
</ol>
<h2 id="error-codes-documentation">Error Codes Documentation </h2>
<h3 id="overview-4">Overview </h3>
<p>AMKT v2 uses custom errors for gas-efficient error handling and better developer experience. This document outlines all error codes, their meanings, and how to handle them.</p>
<h3 id="core-errors">Core Errors </h3>
<h4 id="vault-errors">Vault Errors </h4>
<h5 id="insufficientbalance">InsufficientBalance </h5>
<p>Thrown when an operation requires more tokens than available.</p>
<pre data-role="codeBlock" data-info="solidity" class="language-solidity solidity"><code>error <span class="token function">InsufficientBalance</span><span class="token punctuation">(</span>
    <span class="token builtin">address</span> token<span class="token punctuation">,</span>
    <span class="token builtin">uint256</span> required<span class="token punctuation">,</span>
    <span class="token builtin">uint256</span> available
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p><strong>Common Scenarios</strong>:</p>
<ul>
<li>Withdrawal exceeds balance</li>
<li>Transfer amount too high</li>
<li>Redemption insufficient tokens</li>
<li>Staking more than owned</li>
<li>Fee payment shortfall</li>
</ul>
<h5 id="invalidtoken">InvalidToken </h5>
<p>Thrown when attempting to interact with an unsupported token.</p>
<pre data-role="codeBlock" data-info="solidity" class="language-solidity solidity"><code>error <span class="token function">InvalidToken</span><span class="token punctuation">(</span>
    <span class="token builtin">address</span> token
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p><strong>Typical Cases</strong>:</p>
<ul>
<li>Non-whitelisted token</li>
<li>Zero address provided</li>
<li>Deprecated token version</li>
<li>Blacklisted address</li>
<li>Non-compliant ERC20</li>
</ul>
<h5 id="maxcapacityexceeded">MaxCapacityExceeded </h5>
<p>Thrown when a deposit would exceed the vault's maximum capacity.</p>
<pre data-role="codeBlock" data-info="solidity" class="language-solidity solidity"><code>error <span class="token function">MaxCapacityExceeded</span><span class="token punctuation">(</span>
    <span class="token builtin">uint256</span> attempted<span class="token punctuation">,</span>
    <span class="token builtin">uint256</span> maximum
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p><strong>Common Triggers</strong>:</p>
<ul>
<li>Large deposits</li>
<li>Mint operations</li>
<li>Rebalancing actions</li>
<li>Batch transfers</li>
<li>Inflation events</li>
</ul>
<h4 id="rebalance-errors">Rebalance Errors </h4>
<h5 id="invalidbounty">InvalidBounty </h5>
<p>Thrown when a bounty's parameters are invalid.</p>
<pre data-role="codeBlock" data-info="solidity" class="language-solidity solidity"><code>error <span class="token function">InvalidBounty</span><span class="token punctuation">(</span>
    <span class="token builtin">bytes32</span> bountyHash<span class="token punctuation">,</span>
    <span class="token builtin">string</span> reason
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p><strong>Validation Failures</strong>:</p>
<ul>
<li>Invalid signature</li>
<li>Incorrect parameters</li>
<li>Malformed data</li>
<li>Unauthorized source</li>
<li>Logic conflicts</li>
</ul>
<h5 id="expiredbounty">ExpiredBounty </h5>
<p>Thrown when attempting to execute an expired bounty.</p>
<pre data-role="codeBlock" data-info="solidity" class="language-solidity solidity"><code>error <span class="token function">ExpiredBounty</span><span class="token punctuation">(</span>
    <span class="token builtin">uint256</span> deadline<span class="token punctuation">,</span>
    <span class="token builtin">uint256</span> currentTime
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p><strong>Time-Related Issues</strong>:</p>
<ul>
<li>Execution after deadline</li>
<li>Block timestamp conflicts</li>
<li>Network delays</li>
<li>Timing constraints</li>
<li>Grace period exceeded</li>
</ul>
<h5 id="slippageexceeded">SlippageExceeded </h5>
<p>Thrown when trade slippage exceeds allowed threshold.</p>
<pre data-role="codeBlock" data-info="solidity" class="language-solidity solidity"><code>error <span class="token function">SlippageExceeded</span><span class="token punctuation">(</span>
    <span class="token builtin">address</span> token<span class="token punctuation">,</span>
    <span class="token builtin">uint256</span> expected<span class="token punctuation">,</span>
    <span class="token builtin">uint256</span> received
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p><strong>Market Conditions</strong>:</p>
<ul>
<li>High volatility</li>
<li>Low liquidity</li>
<li>Large trade impact</li>
<li>Price manipulation</li>
<li>Oracle delays</li>
</ul>
<h4 id="governance-errors">Governance Errors </h4>
<h5 id="unauthorizedproposer">UnauthorizedProposer </h5>
<p>Thrown when an address attempts to create a proposal without sufficient voting power.</p>
<pre data-role="codeBlock" data-info="solidity" class="language-solidity solidity"><code>error <span class="token function">UnauthorizedProposer</span><span class="token punctuation">(</span>
    <span class="token builtin">address</span> proposer<span class="token punctuation">,</span>
    <span class="token builtin">uint256</span> votingPower<span class="token punctuation">,</span>
    <span class="token builtin">uint256</span> required
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p><strong>Authorization Issues</strong>:</p>
<ul>
<li>Insufficient tokens</li>
<li>Delegation problems</li>
<li>Power threshold</li>
<li>Lock period</li>
<li>Voting rights</li>
</ul>
<h5 id="invalidproposalstate">InvalidProposalState </h5>
<p>Thrown when attempting an action on a proposal in an invalid state.</p>
<pre data-role="codeBlock" data-info="solidity" class="language-solidity solidity"><code>error <span class="token function">InvalidProposalState</span><span class="token punctuation">(</span>
    <span class="token builtin">uint256</span> proposalId<span class="token punctuation">,</span>
    <span class="token builtin">uint8</span> currentState<span class="token punctuation">,</span>
    <span class="token builtin">uint8</span> requiredState
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p><strong>State Conflicts</strong>:</p>
<ul>
<li>Premature execution</li>
<li>Double execution</li>
<li>Cancelled proposals</li>
<li>Queued status</li>
<li>Grace period</li>
</ul>
<h3 id="access-control-errors">Access Control Errors </h3>
<h5 id="unauthorized">Unauthorized </h5>
<p>Thrown when an operation is attempted by an unauthorized address.</p>
<pre data-role="codeBlock" data-info="solidity" class="language-solidity solidity"><code>error <span class="token function">Unauthorized</span><span class="token punctuation">(</span>
    <span class="token builtin">address</span> caller<span class="token punctuation">,</span>
    <span class="token builtin">bytes4</span> functionSelector
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p><strong>Permission Issues</strong>:</p>
<ul>
<li>Role missing</li>
<li>Admin functions</li>
<li>Restricted operations</li>
<li>Time locks</li>
<li>Multi-sig requirements</li>
</ul>
<h5 id="invalidmultisig">InvalidMultisig </h5>
<p>Thrown when a multisig operation fails validation.</p>
<pre data-role="codeBlock" data-info="solidity" class="language-solidity solidity"><code>error <span class="token function">InvalidMultisig</span><span class="token punctuation">(</span>
    <span class="token builtin">uint256</span> signaturesProvided<span class="token punctuation">,</span>
    <span class="token builtin">uint256</span> signaturesRequired
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p><strong>Signature Problems</strong>:</p>
<ul>
<li>Insufficient signatures</li>
<li>Invalid signers</li>
<li>Duplicate signatures</li>
<li>Expired signatures</li>
<li>Wrong order</li>
</ul>
<h3 id="error-handling-examples">Error Handling Examples </h3>
<h4 id="contract-level">Contract Level </h4>
<pre data-role="codeBlock" data-info="solidity" class="language-solidity solidity"><code><span class="token keyword keyword-contract">contract</span> <span class="token class-name">AMKTVault</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-function">function</span> <span class="token function">withdraw</span><span class="token punctuation">(</span><span class="token builtin">address</span> token<span class="token punctuation">,</span> <span class="token builtin">uint256</span> amount<span class="token punctuation">)</span> <span class="token keyword keyword-external">external</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>balances<span class="token punctuation">[</span>token<span class="token punctuation">]</span><span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span> <span class="token operator">&lt;</span> amount<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword keyword-revert">revert</span> <span class="token function">InsufficientBalance</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                token<span class="token punctuation">:</span> token<span class="token punctuation">,</span>
                required<span class="token punctuation">:</span> amount<span class="token punctuation">,</span>
                available<span class="token punctuation">:</span> balances<span class="token punctuation">[</span>token<span class="token punctuation">]</span><span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// ... withdrawal logic</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><h4 id="client-level-typescript">Client Level (TypeScript) </h4>
<pre data-role="codeBlock" data-info="typescript" class="language-typescript typescript"><code><span class="token keyword keyword-async">async</span> <span class="token keyword keyword-function">function</span> <span class="token function">safeWithdraw</span><span class="token punctuation">(</span>token<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> amount<span class="token operator">:</span> BigNumber<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-try">try</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-const">const</span> tx <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> vault<span class="token punctuation">.</span><span class="token function">withdraw</span><span class="token punctuation">(</span>token<span class="token punctuation">,</span> amount<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-await">await</span> tx<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword keyword-catch">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">.</span>code <span class="token operator">===</span> <span class="token string">'InsufficientBalance'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>
                <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Insufficient balance: Required </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>error<span class="token punctuation">.</span>args<span class="token punctuation">.</span>required<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">, </span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
                <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Available: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>error<span class="token punctuation">.</span>args<span class="token punctuation">.</span>available<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// Handle insufficient balance</span>
        <span class="token punctuation">}</span>
        <span class="token keyword keyword-throw">throw</span> error<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><h3 id="error-handling-best-practices">Error Handling Best Practices </h3>
<ol>
<li><strong>Custom Error Decoding</strong></li>
</ol>
<pre data-role="codeBlock" data-info="typescript" class="language-typescript typescript"><code><span class="token keyword keyword-interface">interface</span> <span class="token class-name">DecodedError</span> <span class="token punctuation">{</span>
    name<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
    args<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword keyword-function">function</span> <span class="token function">decodeError</span><span class="token punctuation">(</span>error<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span><span class="token operator">:</span> DecodedError <span class="token punctuation">{</span>
    <span class="token keyword keyword-const">const</span> iface <span class="token operator">=</span> <span class="token keyword keyword-new">new</span> <span class="token class-name">ethers</span><span class="token punctuation">.</span>utils<span class="token punctuation">.</span><span class="token function">Interface</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
        <span class="token string">"error InsufficientBalance(address,uint256,uint256)"</span><span class="token punctuation">,</span>
        <span class="token string">"error InvalidToken(address)"</span><span class="token punctuation">,</span>
        <span class="token comment">// ... other error definitions</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword keyword-try">try</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-const">const</span> decoded <span class="token operator">=</span> iface<span class="token punctuation">.</span><span class="token function">parseError</span><span class="token punctuation">(</span>error<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-return">return</span> <span class="token punctuation">{</span>
            name<span class="token operator">:</span> decoded<span class="token punctuation">.</span>name<span class="token punctuation">,</span>
            args<span class="token operator">:</span> decoded<span class="token punctuation">.</span>args
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword keyword-catch">catch</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-return">return</span> <span class="token punctuation">{</span>
            name<span class="token operator">:</span> <span class="token string">"Unknown"</span><span class="token punctuation">,</span>
            args<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><ol start="2">
<li><strong>Error Recovery Strategies</strong></li>
</ol>
<pre data-role="codeBlock" data-info="typescript" class="language-typescript typescript"><code><span class="token keyword keyword-async">async</span> <span class="token keyword keyword-function">function</span> <span class="token function">executeWithRetry</span><span class="token punctuation">(</span>
    <span class="token function-variable function">operation</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    maxAttempts<span class="token operator">:</span> <span class="token builtin">number</span> <span class="token operator">=</span> <span class="token number">3</span>
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-let">let</span> lastError<span class="token punctuation">;</span>
    
    <span class="token keyword keyword-for">for</span> <span class="token punctuation">(</span><span class="token keyword keyword-let">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> maxAttempts<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-try">try</span> <span class="token punctuation">{</span>
            <span class="token keyword keyword-return">return</span> <span class="token keyword keyword-await">await</span> <span class="token function">operation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword keyword-catch">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            lastError <span class="token operator">=</span> error<span class="token punctuation">;</span>
            <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isRetryableError</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword keyword-throw">throw</span> error<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword keyword-await">await</span> <span class="token function">delay</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">pow</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Exponential backoff</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword keyword-throw">throw</span> lastError<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><h3 id="error-monitoring">Error Monitoring </h3>
<ol>
<li><strong>Error Aggregation</strong></li>
</ol>
<pre data-role="codeBlock" data-info="typescript" class="language-typescript typescript"><code><span class="token keyword keyword-interface">interface</span> <span class="token class-name">ErrorMetrics</span> <span class="token punctuation">{</span>
    errorCode<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
    frequency<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
    lastOccurrence<span class="token operator">:</span> Date<span class="token punctuation">;</span>
    affectedAddresses<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword keyword-class">class</span> <span class="token class-name">ErrorMonitor</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-private">private</span> metrics<span class="token operator">:</span> Map<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token punctuation">,</span> ErrorMetrics<span class="token operator">&gt;</span><span class="token punctuation">;</span>
    
    <span class="token function">logError</span><span class="token punctuation">(</span>error<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">,</span> address<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-const">const</span> decoded <span class="token operator">=</span> <span class="token function">decodeError</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// Update metrics</span>
        <span class="token comment">// Trigger alerts if necessary</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><ol start="2">
<li><strong>Alert Thresholds</strong></li>
</ol>
<pre data-role="codeBlock" data-info="typescript" class="language-typescript typescript"><code><span class="token keyword keyword-const">const</span> <span class="token constant">ERROR_THRESHOLDS</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    InsufficientBalance<span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span>  <span class="token comment">// Alert after 10 occurrences</span>
    SlippageExceeded<span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span>     <span class="token comment">// Alert after 5 occurrences</span>
    InvalidMultisig<span class="token operator">:</span> <span class="token number">1</span>       <span class="token comment">// Alert immediately</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><h3 id="security-implications">Security Implications </h3>
<ol>
<li>
<p><strong>Error Information Exposure</strong></p>
<ul>
<li>Avoid exposing sensitive information in error messages</li>
<li>Sanitize error data before logging</li>
<li>Use appropriate error visibility levels</li>
</ul>
</li>
<li>
<p><strong>Error Recovery</strong></p>
<ul>
<li>Implement safe fallback states</li>
<li>Ensure atomic operations</li>
<li>Handle partial failures gracefully</li>
</ul>
</li>
<li>
<p><strong>Monitoring and Alerts</strong></p>
<ul>
<li>Set up real-time error monitoring</li>
<li>Define critical error thresholds</li>
<li>Implement automated response procedures</li>
</ul>
</li>
</ol>
<h2 id="testing-documentation">Testing Documentation </h2>
<h3 id="testing-overview">Overview </h3>
<p>AMKT v2 employs a comprehensive testing strategy using two complementary frameworks:</p>
<ul>
<li><strong>Foundry</strong>: For unit and integration testing, providing rapid feedback and high test coverage</li>
<li><strong>Halmos</strong>: For symbolic testing and formal verification, ensuring mathematical correctness of critical operations</li>
</ul>
<p>Each framework serves distinct but complementary purposes in ensuring system reliability.</p>
<h3 id="foundry-tests">Foundry Tests </h3>
<h4 id="setup">Setup </h4>
<p>Standard installation and test execution:</p>
<pre data-role="codeBlock" data-info="bash" class="language-bash bash"><code><span class="token comment"># Install Foundry - development framework for robust testing</span>
<span class="token function">curl</span> <span class="token parameter variable">-L</span> https://foundry.paradigm.xyz <span class="token operator">|</span> <span class="token function">bash</span>
foundryup

<span class="token comment"># Run tests from the contracts directory</span>
<span class="token builtin class-name">cd</span> contracts
forge <span class="token builtin class-name">test</span>
</code></pre><h4 id="test-structure">Test Structure </h4>
<p>Tests are organized hierarchically for maintainability and clarity:</p>
<pre data-role="codeBlock" data-info="solidity:contracts/test/" class="language-solidity:contracts/test/ solidity:contracts/test/"><code>// Base test setup - provides common testing infrastructure
abstract contract TestBase {
    Vault vault;              // Core vault contract
    Issuance issuance;        // Token issuance management
    InvokeableBounty bounty;  // Rebalancing mechanism
    // ... other common test setup
}

// Test categories - organized by major system components
contract VaultTest is TestBase {
    function testVirtualUnits() public { /* Tests unit calculation logic */ }
    function testInvokeERC20s() public { /* Tests token interaction safety */ }
    // ... other vault tests
}

contract IssuanceTest is TestBase {
    function testIssue() public { /* Tests token minting process */ }
    function testRedeem() public { /* Tests redemption mechanics */ }
    // ... other issuance tests
}
</code></pre><h4 id="key-test-commands">Key Test Commands </h4>
<p>Essential commands for different testing scenarios:</p>
<pre data-role="codeBlock" data-info="bash" class="language-bash bash"><code><span class="token comment"># Run all tests - comprehensive system verification</span>
forge <span class="token builtin class-name">test</span>

<span class="token comment"># Run specific test file - focused component testing</span>
forge <span class="token builtin class-name">test</span> --match-path test/Vault.t.sol

<span class="token comment"># Run tests with specific pattern - targeted feature testing</span>
forge <span class="token builtin class-name">test</span> --match-test <span class="token string">"testIssue"</span>

<span class="token comment"># Run tests with gas reporting - optimization analysis</span>
forge <span class="token builtin class-name">test</span> --gas-report

<span class="token comment"># Run tests with verbosity - detailed debugging output</span>
forge <span class="token builtin class-name">test</span> <span class="token parameter variable">-vvv</span>
</code></pre><h3 id="symbolic-testing">Symbolic Testing with Halmos </h3>
<h4 id="setup-1">Setup </h4>
<p>Installation and execution of formal verification tools:</p>
<pre data-role="codeBlock" data-info="bash" class="language-bash bash"><code><span class="token comment"># Install Halmos for symbolic testing</span>
<span class="token function">cargo</span> <span class="token function">install</span> halmos

<span class="token comment"># Run symbolic tests from contracts directory</span>
<span class="token builtin class-name">cd</span> contracts
halmos
</code></pre><h4 id="key-test-areas">Key Test Areas </h4>
<h5 id="1-state-invariants">1. State Invariants </h5>
<p>Critical system properties that must always hold:</p>
<pre data-role="codeBlock" data-info="solidity" class="language-solidity solidity"><code><span class="token comment">// Example invariant test - validates core economic properties</span>
<span class="token keyword keyword-function">function</span> <span class="token function">invariant_totalSupply</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword keyword-public">public</span> <span class="token punctuation">{</span>
    <span class="token function">assertEq</span><span class="token punctuation">(</span>
        token<span class="token punctuation">.</span><span class="token function">totalSupply</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        initialSupply <span class="token operator">+</span> minted <span class="token operator">-</span> burned<span class="token punctuation">,</span>
        <span class="token string">"Supply invariant violated"</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><h5 id="2-access-control">2. Access Control </h5>
<p>Verification of permission systems:</p>
<pre data-role="codeBlock" data-info="solidity" class="language-solidity solidity"><code><span class="token comment">// Example access control test - ensures proper authorization</span>
<span class="token keyword keyword-function">function</span> <span class="token function">verify_onlyAuthorized</span><span class="token punctuation">(</span><span class="token builtin">address</span> caller<span class="token punctuation">)</span> <span class="token keyword keyword-public">public</span> <span class="token punctuation">{</span>
    vm<span class="token punctuation">.</span><span class="token function">assume</span><span class="token punctuation">(</span>caller <span class="token operator">!=</span> authorized<span class="token punctuation">)</span><span class="token punctuation">;</span>
    vm<span class="token punctuation">.</span><span class="token function">expectRevert</span><span class="token punctuation">(</span><span class="token string">"Unauthorized"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    vault<span class="token punctuation">.</span><span class="token function">invokeERC20s</span><span class="token punctuation">(</span>caller<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><h3 id="test-coverage">Test Coverage </h3>
<p>Comprehensive coverage reporting tools:</p>
<pre data-role="codeBlock" data-info="bash" class="language-bash bash"><code><span class="token comment"># Generate basic test coverage report</span>
forge coverage

<span class="token comment"># Generate detailed HTML coverage report for analysis</span>
forge coverage <span class="token parameter variable">--report</span> lcov
genhtml lcov.info <span class="token parameter variable">-o</span> coverage
</code></pre><h3 id="testing-best-practices">Testing Best Practices </h3>
<h4 id="1-test-organization">1. Test Organization </h4>
<p>Structured approach to test case design:</p>
<pre data-role="codeBlock" data-info="solidity" class="language-solidity solidity"><code><span class="token keyword keyword-contract">contract</span> <span class="token class-name">ContractTest</span> <span class="token punctuation">{</span>
    <span class="token comment">// Setup - initialize test environment</span>
    <span class="token keyword keyword-function">function</span> <span class="token function">setUp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword keyword-public">public</span> <span class="token punctuation">{</span> <span class="token comment">/* Configure test state */</span> <span class="token punctuation">}</span>

    <span class="token comment">// Happy path tests - verify expected behavior</span>
    <span class="token keyword keyword-function">function</span> <span class="token function">test_StandardOperation</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword keyword-public">public</span> <span class="token punctuation">{</span> <span class="token comment">/* Test normal flow */</span> <span class="token punctuation">}</span>

    <span class="token comment">// Edge cases - verify boundary conditions</span>
    <span class="token keyword keyword-function">function</span> <span class="token function">test_EdgeCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword keyword-public">public</span> <span class="token punctuation">{</span> <span class="token comment">/* Test extreme scenarios */</span> <span class="token punctuation">}</span>

    <span class="token comment">// Failure cases - verify proper error handling</span>
    <span class="token keyword keyword-function">function</span> <span class="token function">testFail_InvalidInput</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword keyword-public">public</span> <span class="token punctuation">{</span> <span class="token comment">/* Test error conditions */</span> <span class="token punctuation">}</span>

    <span class="token comment">// Fuzz tests - verify behavior across random inputs</span>
    <span class="token keyword keyword-function">function</span> <span class="token function">testFuzz_Operation</span><span class="token punctuation">(</span><span class="token builtin">uint256</span> amount<span class="token punctuation">)</span> <span class="token keyword keyword-public">public</span> <span class="token punctuation">{</span> <span class="token comment">/* Property-based testing */</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><h4 id="test-scenarios">2. Common Test Scenarios </h4>
<h5 id="vault-testing">Vault Testing </h5>
<p>Comprehensive vault functionality verification:</p>
<pre data-role="codeBlock" data-info="solidity" class="language-solidity solidity"><code><span class="token keyword keyword-function">function</span> <span class="token function">test_VaultOperations</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword keyword-public">public</span> <span class="token punctuation">{</span>
    <span class="token comment">// Test asset deposits - verify safe token handling</span>
    <span class="token comment">// Test withdrawals - ensure proper balance accounting</span>
    <span class="token comment">// Test fee calculations - validate economic model</span>
    <span class="token comment">// Test emergency procedures - verify safety mechanisms</span>
<span class="token punctuation">}</span>
</code></pre><h5 id="issuance-testing">Issuance Testing </h5>
<p>Token lifecycle verification:</p>
<pre data-role="codeBlock" data-info="solidity" class="language-solidity solidity"><code><span class="token keyword keyword-function">function</span> <span class="token function">test_IssuanceFlow</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword keyword-public">public</span> <span class="token punctuation">{</span>
    <span class="token comment">// Test token minting - verify supply management</span>
    <span class="token comment">// Test redemptions - ensure proper value exchange</span>
    <span class="token comment">// Test slippage protection - verify price safety</span>
<span class="token punctuation">}</span>
</code></pre><h5 id="bounty-testing">Bounty Testing </h5>
<p>Rebalancing mechanism verification:</p>
<pre data-role="codeBlock" data-info="solidity" class="language-solidity solidity"><code><span class="token keyword keyword-function">function</span> <span class="token function">test_BountyExecution</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword keyword-public">public</span> <span class="token punctuation">{</span>
    <span class="token comment">// Test bounty validation - verify proof checking</span>
    <span class="token comment">// Test rebalancing logic - ensure weight compliance</span>
    <span class="token comment">// Test deadline enforcement - verify temporal constraints</span>
<span class="token punctuation">}</span>
</code></pre><h4 id="fuzzing-parameters">3. Fuzzing Parameters </h4>
<p>Advanced property-based testing configuration:</p>
<pre data-role="codeBlock" data-info="bash" class="language-bash bash"><code><span class="token comment"># Run fuzz tests with enhanced parameters</span>
forge <span class="token builtin class-name">test</span> --fuzz-runs <span class="token number">10000</span> --fuzz-max-local-rejects <span class="token number">100000</span>
</code></pre><h2 id="cicd-integration-and-testing-guide">CI/CD Integration and Testing Guide </h2>
<h3 id="cicd-integration">CI/CD Integration </h3>
<p>Continuous Integration and Continuous Deployment (CI/CD) is crucial for maintaining code quality and ensuring reliable deployments.</p>
<h4 id="github-actions-workflow">GitHub Actions Workflow </h4>
<p>This workflow runs on every push and pull request to catch issues early. Key components:</p>
<ul>
<li>Uses Ubuntu for consistent testing environment</li>
<li>Installs Foundry for Solidity testing</li>
<li>Runs both standard tests and formal verification (Halmos)</li>
</ul>
<pre data-role="codeBlock" data-info="yaml" class="language-yaml yaml"><code><span class="token key atrule">name</span><span class="token punctuation">:</span> Tests
<span class="token key atrule">on</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>push<span class="token punctuation">,</span> pull_request<span class="token punctuation">]</span>

<span class="token key atrule">jobs</span><span class="token punctuation">:</span>
  <span class="token key atrule">tests</span><span class="token punctuation">:</span>
    <span class="token key atrule">runs-on</span><span class="token punctuation">:</span> ubuntu<span class="token punctuation">-</span>latest
    <span class="token key atrule">steps</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">uses</span><span class="token punctuation">:</span> actions/checkout@v2
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Install Foundry
        <span class="token key atrule">uses</span><span class="token punctuation">:</span> foundry<span class="token punctuation">-</span>rs/foundry<span class="token punctuation">-</span>toolchain@v1
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Run tests
        <span class="token key atrule">run</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
          cd contracts
          forge test</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Run Halmos
        <span class="token key atrule">run</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
          cd contracts
          halmos</span>
</code></pre><h3 id="debugging-tools">Debugging Tools </h3>
<p>Effective debugging is essential for smart contract development. These tools help identify and resolve issues quickly.</p>
<h4 id="trace-logging">Trace Logging </h4>
<p>Verbose logging helps track contract execution flow:</p>
<ul>
<li><code>-v</code>: Shows basic test logs</li>
<li><code>-vv</code>: Adds gas reports</li>
<li><code>-vvv</code>: Includes stack traces</li>
<li><code>-vvvv</code>: Provides full debug output with step-by-step execution</li>
</ul>
<pre data-role="codeBlock" data-info="bash" class="language-bash bash"><code><span class="token comment">## Run tests with detailed traces</span>
forge <span class="token builtin class-name">test</span> <span class="token parameter variable">-vvvv</span>
</code></pre><h4 id="gas-snapshots">Gas Snapshots </h4>
<p>Gas monitoring is crucial for optimization:</p>
<ul>
<li>Regular snapshots help track gas changes</li>
<li>Useful for identifying expensive operations</li>
<li>Helps maintain consistent gas costs</li>
<li>Essential for upgrade planning</li>
</ul>
<pre data-role="codeBlock" data-info="bash" class="language-bash bash"><code><span class="token comment">## Create gas snapshot</span>
forge snapshot

<span class="token comment">## Compare gas usage</span>
forge snapshot <span class="token parameter variable">--check</span>
</code></pre><h4 id="debug-console">Debug Console </h4>
<p>Console logging during tests provides insights into:</p>
<ul>
<li>Variable values at specific execution points</li>
<li>Address interactions</li>
<li>State changes</li>
<li>Event emissions</li>
<li>Error conditions</li>
</ul>
<pre data-role="codeBlock" data-info="solidity" class="language-solidity solidity"><code><span class="token keyword keyword-function">function</span> <span class="token function">test_Debug</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword keyword-public">public</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"Debug value:"</span><span class="token punctuation">,</span> someValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">logAddress</span><span class="token punctuation">(</span><span class="token builtin">address</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">logUint</span><span class="token punctuation">(</span>amount<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><h3 id="common-issues-and-solutions">Common Issues and Solutions </h3>
<p>Understanding common problems and their solutions speeds up development.</p>
<h4 id="gas-estimation-failures">Gas Estimation Failures </h4>
<p>Gas issues often occur due to:</p>
<ul>
<li>Complex operations</li>
<li>Large state changes</li>
<li>Array operations</li>
<li>External contract calls</li>
<li>Loop iterations</li>
</ul>
<pre data-role="codeBlock" data-info="bash" class="language-bash bash"><code><span class="token comment">## Run with higher gas limit</span>
forge <span class="token builtin class-name">test</span> --gas-limit <span class="token number">9000000</span>
</code></pre><h4 id="memory-issues">Memory Issues </h4>
<p>Memory management is critical:</p>
<ul>
<li>Large data structures</li>
<li>String operations</li>
<li>Array manipulations</li>
<li>Contract deployment size</li>
<li>Test suite complexity</li>
</ul>
<pre data-role="codeBlock" data-info="bash" class="language-bash bash"><code><span class="token comment">## Adjust memory limits</span>
forge <span class="token builtin class-name">test</span> --memory-limit <span class="token number">4096</span>
</code></pre><h4 id="stack-too-deep">Stack Too Deep </h4>
<p>Stack depth issues typically arise from:</p>
<ul>
<li>Too many local variables</li>
<li>Complex function logic</li>
<li>Nested function calls</li>
<li>Large struct returns</li>
<li>Multiple memory operations</li>
</ul>
<pre data-role="codeBlock" data-info="solidity" class="language-solidity solidity"><code><span class="token comment">// Break down complex tests into smaller functions</span>
<span class="token keyword keyword-function">function</span> <span class="token function">helperFunction</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword keyword-internal">internal</span> <span class="token keyword keyword-returns">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint256</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Complex logic here</span>
<span class="token punctuation">}</span>
</code></pre><h4 id="additional-best-practices">Additional Best Practices </h4>
<ol>
<li>
<p><strong>Test Organization</strong></p>
<ul>
<li>Group related tests</li>
<li>Use descriptive names</li>
<li>Maintain test independence</li>
<li>Mock external dependencies</li>
<li>Test edge cases</li>
</ul>
</li>
<li>
<p><strong>CI Pipeline Optimization</strong></p>
<ul>
<li>Cache dependencies</li>
<li>Parallel test execution</li>
<li>Selective testing</li>
<li>Regular cleanup</li>
<li>Resource management</li>
</ul>
</li>
<li>
<p><strong>Monitoring and Alerts</strong></p>
<ul>
<li>Test failure notifications</li>
<li>Gas usage warnings</li>
<li>Coverage reports</li>
<li>Build time tracking</li>
<li>Environment status</li>
</ul>
</li>
</ol>
<h2 id="security-considerations-2">Security Considerations </h2>
<h3 id="overview-5">Overview </h3>
<p>AMKT v2 implements multiple layers of security measures to protect user funds and ensure system integrity. The security architecture follows defense-in-depth principles:</p>
<ul>
<li>Multiple independent authorization layers</li>
<li>Time-delayed operations for critical changes</li>
<li>Economic security through slippage controls</li>
<li>Automated monitoring and alerting systems</li>
<li>Emergency response capabilities</li>
</ul>
<h3 id="access-control">Access Control </h3>
<h4 id="role-based-permissions">Role-Based Permissions </h4>
<p>The system implements granular role-based access control (RBAC) to ensure precise permission management:</p>
<h5 id="core-roles">Core Roles </h5>
<p>Each role serves a specific purpose with carefully scoped permissions:</p>
<pre data-role="codeBlock" data-info="solidity" class="language-solidity solidity"><code><span class="token keyword keyword-enum">enum</span> <span class="token class-name">Role</span> <span class="token punctuation">{</span>
    ADMIN<span class="token punctuation">,</span>      <span class="token comment">// System-wide configuration changes</span>
    OPERATOR<span class="token punctuation">,</span>   <span class="token comment">// Day-to-day operations</span>
    FULFILLER<span class="token punctuation">,</span>  <span class="token comment">// Rebalance execution</span>
    EMERGENCY_MULTISIG<span class="token punctuation">,</span>  <span class="token comment">// Emergency interventions</span>
    GUARDIAN    <span class="token comment">// Circuit breaker control</span>
<span class="token punctuation">}</span>
</code></pre><h5 id="implementation-example">Implementation Example </h5>
<p>Secure role management with strict access controls:</p>
<pre data-role="codeBlock" data-info="solidity" class="language-solidity solidity"><code><span class="token keyword keyword-contract">contract</span> <span class="token class-name">AccessControl</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-mapping">mapping</span><span class="token punctuation">(</span><span class="token builtin">address</span> <span class="token operator">=&gt;</span> <span class="token keyword keyword-mapping">mapping</span><span class="token punctuation">(</span>Role <span class="token operator">=&gt;</span> <span class="token builtin">bool</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword keyword-private">private</span> roles<span class="token punctuation">;</span>
    
    <span class="token keyword keyword-modifier">modifier</span> <span class="token function">onlyRole</span><span class="token punctuation">(</span>Role role<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-require">require</span><span class="token punctuation">(</span>roles<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span><span class="token punctuation">[</span>role<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"Unauthorized"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-_">_</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword keyword-function">function</span> <span class="token function">grantRole</span><span class="token punctuation">(</span><span class="token builtin">address</span> account<span class="token punctuation">,</span> Role role<span class="token punctuation">)</span> 
        <span class="token keyword keyword-external">external</span> 
        <span class="token function">onlyRole</span><span class="token punctuation">(</span>Role<span class="token punctuation">.</span>ADMIN<span class="token punctuation">)</span> 
    <span class="token punctuation">{</span>
        roles<span class="token punctuation">[</span>account<span class="token punctuation">]</span><span class="token punctuation">[</span>role<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><h4 id="time-locks">Time Locks </h4>
<h5 id="governance-delay">Governance Delay </h5>
<p>Enforces mandatory waiting periods for critical operations:</p>
<pre data-role="codeBlock" data-info="solidity" class="language-solidity solidity"><code><span class="token keyword keyword-contract">contract</span> <span class="token class-name">TimelockController</span> <span class="token punctuation">{</span>
    <span class="token builtin">uint256</span> <span class="token keyword keyword-public">public</span> <span class="token keyword keyword-constant">constant</span> MIN_DELAY <span class="token operator">=</span> <span class="token number">2</span> days<span class="token punctuation">;</span>    <span class="token comment">// Minimum safety window</span>
    <span class="token builtin">uint256</span> <span class="token keyword keyword-public">public</span> <span class="token keyword keyword-constant">constant</span> MAX_DELAY <span class="token operator">=</span> <span class="token number">30</span> days<span class="token punctuation">;</span>   <span class="token comment">// Maximum delay to prevent deadlocks</span>
    
    <span class="token keyword keyword-mapping">mapping</span><span class="token punctuation">(</span><span class="token builtin">bytes32</span> <span class="token operator">=&gt;</span> <span class="token builtin">uint256</span><span class="token punctuation">)</span> <span class="token keyword keyword-public">public</span> operationTimestamps<span class="token punctuation">;</span>
    
    <span class="token keyword keyword-function">function</span> <span class="token function">scheduleOperation</span><span class="token punctuation">(</span><span class="token builtin">bytes32</span> operationId<span class="token punctuation">)</span> <span class="token keyword keyword-external">external</span> <span class="token punctuation">{</span>
        operationTimestamps<span class="token punctuation">[</span>operationId<span class="token punctuation">]</span> <span class="token operator">=</span> block<span class="token punctuation">.</span>timestamp <span class="token operator">+</span> delay<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword keyword-function">function</span> <span class="token function">executeOperation</span><span class="token punctuation">(</span><span class="token builtin">bytes32</span> operationId<span class="token punctuation">)</span> <span class="token keyword keyword-external">external</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-require">require</span><span class="token punctuation">(</span>
            block<span class="token punctuation">.</span>timestamp <span class="token operator">&gt;=</span> operationTimestamps<span class="token punctuation">[</span>operationId<span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token string">"Operation not ready"</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// Execute operation</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><h3 id="value-protection">Value Protection </h3>
<h4 id="slippage-control">Slippage Control </h4>
<p>Protects against adverse price movements during trades:</p>
<pre data-role="codeBlock" data-info="solidity" class="language-solidity solidity"><code><span class="token keyword keyword-contract">contract</span> <span class="token class-name">SlippageProtection</span> <span class="token punctuation">{</span>
    <span class="token builtin">uint256</span> <span class="token keyword keyword-public">public</span> <span class="token keyword keyword-constant">constant</span> MAX_SLIPPAGE_BPS <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span> <span class="token comment">// 1% maximum allowed slippage</span>
    
    <span class="token keyword keyword-function">function</span> <span class="token function">validateSlippage</span><span class="token punctuation">(</span>
        <span class="token builtin">uint256</span> expected<span class="token punctuation">,</span>
        <span class="token builtin">uint256</span> actual
    <span class="token punctuation">)</span> <span class="token keyword keyword-internal">internal</span> <span class="token keyword keyword-pure">pure</span> <span class="token punctuation">{</span>
        <span class="token builtin">uint256</span> slippage <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>expected <span class="token operator">-</span> actual<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">10000</span><span class="token punctuation">)</span> <span class="token operator">/</span> expected<span class="token punctuation">;</span>
        <span class="token keyword keyword-require">require</span><span class="token punctuation">(</span>slippage <span class="token operator">&lt;=</span> MAX_SLIPPAGE_BPS<span class="token punctuation">,</span> <span class="token string">"Excessive slippage"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><h4 id="circuit-breakers">Circuit Breakers </h4>
<p>Automatically halts operations when suspicious activity is detected:</p>
<pre data-role="codeBlock" data-info="solidity" class="language-solidity solidity"><code><span class="token keyword keyword-contract">contract</span> <span class="token class-name">CircuitBreaker</span> <span class="token punctuation">{</span>
    <span class="token builtin">uint256</span> <span class="token keyword keyword-public">public</span> <span class="token keyword keyword-constant">constant</span> TRADE_VOLUME_THRESHOLD <span class="token operator">=</span> <span class="token number">1000000e18</span><span class="token punctuation">;</span> <span class="token comment">// $1M threshold</span>
    <span class="token builtin">uint256</span> <span class="token keyword keyword-public">public</span> <span class="token keyword keyword-constant">constant</span> COOL_DOWN_PERIOD <span class="token operator">=</span> <span class="token number">1</span> hours<span class="token punctuation">;</span>
    
    <span class="token builtin">uint256</span> <span class="token keyword keyword-public">public</span> lastBreakTime<span class="token punctuation">;</span>
    <span class="token builtin">uint256</span> <span class="token keyword keyword-public">public</span> currentVolume<span class="token punctuation">;</span>
    
    <span class="token keyword keyword-function">function</span> <span class="token function">checkAndBreak</span><span class="token punctuation">(</span><span class="token builtin">uint256</span> tradeAmount<span class="token punctuation">)</span> <span class="token keyword keyword-internal">internal</span> <span class="token punctuation">{</span>
        currentVolume <span class="token operator">+=</span> tradeAmount<span class="token punctuation">;</span>
        
        <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>currentVolume <span class="token operator">&gt;=</span> TRADE_VOLUME_THRESHOLD<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            lastBreakTime <span class="token operator">=</span> block<span class="token punctuation">.</span>timestamp<span class="token punctuation">;</span>
            <span class="token keyword keyword-emit">emit</span> <span class="token function">CircuitBroken</span><span class="token punctuation">(</span>currentVolume<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword keyword-revert">revert</span><span class="token punctuation">(</span><span class="token string">"Circuit breaker triggered"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><h3 id="smart-contract-security">Smart Contract Security </h3>
<h4 id="reentrancy-protection">Reentrancy Protection </h4>
<p>Guards against recursive call attacks:</p>
<pre data-role="codeBlock" data-info="solidity" class="language-solidity solidity"><code><span class="token keyword keyword-contract">contract</span> <span class="token class-name">ReentrancyGuard</span> <span class="token punctuation">{</span>
    <span class="token builtin">uint256</span> <span class="token keyword keyword-private">private</span> <span class="token keyword keyword-constant">constant</span> _NOT_ENTERED <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token builtin">uint256</span> <span class="token keyword keyword-private">private</span> <span class="token keyword keyword-constant">constant</span> _ENTERED <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token builtin">uint256</span> <span class="token keyword keyword-private">private</span> _status<span class="token punctuation">;</span>
    
    <span class="token keyword keyword-modifier">modifier</span> <span class="token function">nonReentrant</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-require">require</span><span class="token punctuation">(</span>_status <span class="token operator">!=</span> _ENTERED<span class="token punctuation">,</span> <span class="token string">"Reentrant call"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        _status <span class="token operator">=</span> _ENTERED<span class="token punctuation">;</span>
        <span class="token keyword keyword-_">_</span><span class="token punctuation">;</span>
        _status <span class="token operator">=</span> _NOT_ENTERED<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><h4 id="secure-token-transfers">Secure Token Transfers </h4>
<p>Ensures safe token operations with comprehensive checks:</p>
<pre data-role="codeBlock" data-info="solidity" class="language-solidity solidity"><code><span class="token keyword keyword-contract">contract</span> <span class="token class-name">SecureTransfers</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-function">function</span> <span class="token function">safeTransfer</span><span class="token punctuation">(</span>
        IERC20 token<span class="token punctuation">,</span>
        <span class="token builtin">address</span> recipient<span class="token punctuation">,</span>
        <span class="token builtin">uint256</span> amount
    <span class="token punctuation">)</span> <span class="token keyword keyword-internal">internal</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-require">require</span><span class="token punctuation">(</span>recipient <span class="token operator">!=</span> <span class="token builtin">address</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"Invalid recipient"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token builtin">uint256</span> balanceBefore <span class="token operator">=</span> token<span class="token punctuation">.</span><span class="token function">balanceOf</span><span class="token punctuation">(</span><span class="token builtin">address</span><span class="token punctuation">(</span><span class="token keyword keyword-this">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token builtin">bool</span> success <span class="token operator">=</span> token<span class="token punctuation">.</span><span class="token function">transfer</span><span class="token punctuation">(</span>recipient<span class="token punctuation">,</span> amount<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-require">require</span><span class="token punctuation">(</span>success<span class="token punctuation">,</span> <span class="token string">"Transfer failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token builtin">uint256</span> balanceAfter <span class="token operator">=</span> token<span class="token punctuation">.</span><span class="token function">balanceOf</span><span class="token punctuation">(</span><span class="token builtin">address</span><span class="token punctuation">(</span><span class="token keyword keyword-this">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-require">require</span><span class="token punctuation">(</span>
            balanceBefore <span class="token operator">-</span> balanceAfter <span class="token operator">==</span> amount<span class="token punctuation">,</span>
            <span class="token string">"Transfer amount mismatch"</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><h3 id="emergency-procedures">Emergency Procedures </h3>
<h4 id="emergency-shutdown">Emergency Shutdown </h4>
<pre data-role="codeBlock" data-info="solidity" class="language-solidity solidity"><code><span class="token keyword keyword-contract">contract</span> <span class="token class-name">EmergencyProtocol</span> <span class="token punctuation">{</span>
    <span class="token builtin">address</span> <span class="token keyword keyword-public">public</span> immutable emergencyMultisig<span class="token punctuation">;</span>
    <span class="token builtin">bool</span> <span class="token keyword keyword-public">public</span> frozen<span class="token punctuation">;</span>
    
    <span class="token keyword keyword-event">event</span> <span class="token function">EmergencyShutdown</span><span class="token punctuation">(</span><span class="token builtin">address</span> triggered_by<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-event">event</span> <span class="token function">EmergencyResume</span><span class="token punctuation">(</span><span class="token builtin">address</span> triggered_by<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword keyword-modifier">modifier</span> <span class="token function">notFrozen</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-require">require</span><span class="token punctuation">(</span><span class="token operator">!</span>frozen<span class="token punctuation">,</span> <span class="token string">"Protocol is frozen"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-_">_</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword keyword-function">function</span> <span class="token function">initiateEmergencyShutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
        <span class="token keyword keyword-external">external</span> 
        <span class="token function">onlyRole</span><span class="token punctuation">(</span>Role<span class="token punctuation">.</span>EMERGENCY_MULTISIG<span class="token punctuation">)</span> 
    <span class="token punctuation">{</span>
        frozen <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-emit">emit</span> <span class="token function">EmergencyShutdown</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword keyword-function">function</span> <span class="token function">resumeFromEmergency</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword keyword-external">external</span>
        <span class="token function">onlyRole</span><span class="token punctuation">(</span>Role<span class="token punctuation">.</span>EMERGENCY_MULTISIG<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        frozen <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-emit">emit</span> <span class="token function">EmergencyResume</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><h4 id="fund-recovery">Fund Recovery </h4>
<pre data-role="codeBlock" data-info="solidity" class="language-solidity solidity"><code><span class="token keyword keyword-contract">contract</span> <span class="token class-name">FundRecovery</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-function">function</span> <span class="token function">recoverTokens</span><span class="token punctuation">(</span>
        <span class="token builtin">address</span> token<span class="token punctuation">,</span>
        <span class="token builtin">address</span> recipient<span class="token punctuation">,</span>
        <span class="token builtin">uint256</span> amount
    <span class="token punctuation">)</span> <span class="token keyword keyword-external">external</span> <span class="token function">onlyRole</span><span class="token punctuation">(</span>Role<span class="token punctuation">.</span>EMERGENCY_MULTISIG<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-require">require</span><span class="token punctuation">(</span>
            recipient <span class="token operator">==</span> emergencyMultisig<span class="token punctuation">,</span>
            <span class="token string">"Can only recover to emergency multisig"</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">IERC20</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">safeTransfer</span><span class="token punctuation">(</span>recipient<span class="token punctuation">,</span> amount<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-emit">emit</span> <span class="token function">TokensRecovered</span><span class="token punctuation">(</span>token<span class="token punctuation">,</span> recipient<span class="token punctuation">,</span> amount<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><h3 id="monitoring-and-alerts">Monitoring and Alerts </h3>
<h4 id="critical-events">Critical Events </h4>
<pre data-role="codeBlock" data-info="solidity" class="language-solidity solidity"><code><span class="token keyword keyword-interface">interface</span> <span class="token class-name">ISecurityMonitor</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-event">event</span> <span class="token function">LargeTransfer</span><span class="token punctuation">(</span>
        <span class="token builtin">address</span> <span class="token keyword keyword-indexed">indexed</span> token<span class="token punctuation">,</span>
        <span class="token builtin">address</span> <span class="token keyword keyword-indexed">indexed</span> <span class="token keyword keyword-from">from</span><span class="token punctuation">,</span>
        <span class="token builtin">address</span> <span class="token keyword keyword-indexed">indexed</span> to<span class="token punctuation">,</span>
        <span class="token builtin">uint256</span> amount
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword keyword-event">event</span> <span class="token function">SlippageWarning</span><span class="token punctuation">(</span>
        <span class="token builtin">address</span> <span class="token keyword keyword-indexed">indexed</span> token<span class="token punctuation">,</span>
        <span class="token builtin">uint256</span> expected<span class="token punctuation">,</span>
        <span class="token builtin">uint256</span> actual
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword keyword-event">event</span> <span class="token function">UnauthorizedAttempt</span><span class="token punctuation">(</span>
        <span class="token builtin">address</span> <span class="token keyword keyword-indexed">indexed</span> caller<span class="token punctuation">,</span>
        <span class="token builtin">bytes4</span> functionSelector
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><h4 id="monitoring-implementation">Monitoring Implementation </h4>
<pre data-role="codeBlock" data-info="typescript" class="language-typescript typescript"><code><span class="token keyword keyword-class">class</span> <span class="token class-name">SecurityMonitor</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-private">private</span> <span class="token keyword keyword-readonly">readonly</span> <span class="token constant">LARGE_TRANSFER_THRESHOLD</span> <span class="token operator">=</span> ethers<span class="token punctuation">.</span>utils<span class="token punctuation">.</span><span class="token function">parseEther</span><span class="token punctuation">(</span><span class="token string">"100000"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword keyword-async">async</span> <span class="token function">monitorTransfers</span><span class="token punctuation">(</span>transfer<span class="token operator">:</span> TransferEvent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>transfer<span class="token punctuation">.</span>amount<span class="token punctuation">.</span><span class="token function">gt</span><span class="token punctuation">(</span><span class="token keyword keyword-this">this</span><span class="token punctuation">.</span><span class="token constant">LARGE_TRANSFER_THRESHOLD</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword keyword-await">await</span> <span class="token keyword keyword-this">this</span><span class="token punctuation">.</span><span class="token function">alertLargeTransfer</span><span class="token punctuation">(</span>transfer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword keyword-private">private</span> <span class="token keyword keyword-async">async</span> <span class="token function">alertLargeTransfer</span><span class="token punctuation">(</span>transfer<span class="token operator">:</span> TransferEvent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Send alerts to various channels</span>
        <span class="token keyword keyword-await">await</span> <span class="token builtin">Promise</span><span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
            <span class="token keyword keyword-this">this</span><span class="token punctuation">.</span><span class="token function">sendSlackAlert</span><span class="token punctuation">(</span>transfer<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token keyword keyword-this">this</span><span class="token punctuation">.</span><span class="token function">sendEmailAlert</span><span class="token punctuation">(</span>transfer<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token keyword keyword-this">this</span><span class="token punctuation">.</span><span class="token function">triggerPagerDuty</span><span class="token punctuation">(</span>transfer<span class="token punctuation">)</span>
        <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><h3 id="security-best-practices">Security Best Practices </h3>
<ol>
<li>
<p><strong>Code Review Process</strong></p>
<ul>
<li>Multiple independent auditors</li>
<li>Formal verification for critical components</li>
<li>Regular security assessments</li>
</ul>
</li>
<li>
<p><strong>Testing Requirements</strong></p>
<ul>
<li>100% test coverage for critical functions</li>
<li>Fuzz testing for edge cases</li>
<li>Integration tests with mainnet forking</li>
</ul>
</li>
<li>
<p><strong>Deployment Procedure</strong></p>
<ul>
<li>Multi-signature deployment</li>
<li>Gradual rollout strategy</li>
<li>Emergency response team on standby</li>
</ul>
</li>
<li>
<p><strong>Ongoing Maintenance</strong></p>
<ul>
<li>Regular security updates</li>
<li>Vulnerability disclosure program</li>
<li>Incident response planning</li>
</ul>
</li>
</ol>
<h2 id="security-considerations-3">Security Considerations </h2>
<h3 id="overview-6">Overview </h3>
<p>AMKT v2 implements multiple layers of security measures to protect user funds and ensure system integrity. The security architecture follows defense-in-depth principles:</p>
<ul>
<li>Multiple independent authorization layers</li>
<li>Time-delayed operations for critical changes</li>
<li>Economic security through slippage controls</li>
<li>Automated monitoring and alerting systems</li>
<li>Emergency response capabilities</li>
</ul>
<h3 id="access-control-1">Access Control </h3>
<h4 id="role-based-permissions-1">Role-Based Permissions </h4>
<p>The system implements granular role-based access control (RBAC) to ensure precise permission management:</p>
<h5 id="core-roles-1">Core Roles </h5>
<p>Each role serves a specific purpose with carefully scoped permissions:</p>
<pre data-role="codeBlock" data-info="solidity" class="language-solidity solidity"><code><span class="token keyword keyword-enum">enum</span> <span class="token class-name">Role</span> <span class="token punctuation">{</span>
    ADMIN<span class="token punctuation">,</span>      <span class="token comment">// System-wide configuration changes</span>
    OPERATOR<span class="token punctuation">,</span>   <span class="token comment">// Day-to-day operations</span>
    FULFILLER<span class="token punctuation">,</span>  <span class="token comment">// Rebalance execution</span>
    EMERGENCY_MULTISIG<span class="token punctuation">,</span>  <span class="token comment">// Emergency interventions</span>
    GUARDIAN    <span class="token comment">// Circuit breaker control</span>
<span class="token punctuation">}</span>
</code></pre><h5 id="implementation-example-1">Implementation Example </h5>
<p>Secure role management with strict access controls:</p>
<pre data-role="codeBlock" data-info="solidity" class="language-solidity solidity"><code><span class="token keyword keyword-contract">contract</span> <span class="token class-name">AccessControl</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-mapping">mapping</span><span class="token punctuation">(</span><span class="token builtin">address</span> <span class="token operator">=&gt;</span> <span class="token keyword keyword-mapping">mapping</span><span class="token punctuation">(</span>Role <span class="token operator">=&gt;</span> <span class="token builtin">bool</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword keyword-private">private</span> roles<span class="token punctuation">;</span>
    
    <span class="token keyword keyword-modifier">modifier</span> <span class="token function">onlyRole</span><span class="token punctuation">(</span>Role role<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-require">require</span><span class="token punctuation">(</span>roles<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span><span class="token punctuation">[</span>role<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"Unauthorized"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-_">_</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword keyword-function">function</span> <span class="token function">grantRole</span><span class="token punctuation">(</span><span class="token builtin">address</span> account<span class="token punctuation">,</span> Role role<span class="token punctuation">)</span> 
        <span class="token keyword keyword-external">external</span> 
        <span class="token function">onlyRole</span><span class="token punctuation">(</span>Role<span class="token punctuation">.</span>ADMIN<span class="token punctuation">)</span> 
    <span class="token punctuation">{</span>
        roles<span class="token punctuation">[</span>account<span class="token punctuation">]</span><span class="token punctuation">[</span>role<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><h4 id="time-locks-1">Time Locks </h4>
<h5 id="governance-delay-1">Governance Delay </h5>
<p>Enforces mandatory waiting periods for critical operations:</p>
<pre data-role="codeBlock" data-info="solidity" class="language-solidity solidity"><code><span class="token keyword keyword-contract">contract</span> <span class="token class-name">TimelockController</span> <span class="token punctuation">{</span>
    <span class="token builtin">uint256</span> <span class="token keyword keyword-public">public</span> <span class="token keyword keyword-constant">constant</span> MIN_DELAY <span class="token operator">=</span> <span class="token number">2</span> days<span class="token punctuation">;</span>    <span class="token comment">// Minimum safety window</span>
    <span class="token builtin">uint256</span> <span class="token keyword keyword-public">public</span> <span class="token keyword keyword-constant">constant</span> MAX_DELAY <span class="token operator">=</span> <span class="token number">30</span> days<span class="token punctuation">;</span>   <span class="token comment">// Maximum delay to prevent deadlocks</span>
    
    <span class="token keyword keyword-mapping">mapping</span><span class="token punctuation">(</span><span class="token builtin">bytes32</span> <span class="token operator">=&gt;</span> <span class="token builtin">uint256</span><span class="token punctuation">)</span> <span class="token keyword keyword-public">public</span> operationTimestamps<span class="token punctuation">;</span>
    
    <span class="token keyword keyword-function">function</span> <span class="token function">scheduleOperation</span><span class="token punctuation">(</span><span class="token builtin">bytes32</span> operationId<span class="token punctuation">)</span> <span class="token keyword keyword-external">external</span> <span class="token punctuation">{</span>
        operationTimestamps<span class="token punctuation">[</span>operationId<span class="token punctuation">]</span> <span class="token operator">=</span> block<span class="token punctuation">.</span>timestamp <span class="token operator">+</span> delay<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword keyword-function">function</span> <span class="token function">executeOperation</span><span class="token punctuation">(</span><span class="token builtin">bytes32</span> operationId<span class="token punctuation">)</span> <span class="token keyword keyword-external">external</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-require">require</span><span class="token punctuation">(</span>
            block<span class="token punctuation">.</span>timestamp <span class="token operator">&gt;=</span> operationTimestamps<span class="token punctuation">[</span>operationId<span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token string">"Operation not ready"</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// Execute operation</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><h3 id="value-protection-1">Value Protection </h3>
<h4 id="slippage-control-1">Slippage Control </h4>
<p>Protects against adverse price movements during trades:</p>
<pre data-role="codeBlock" data-info="solidity" class="language-solidity solidity"><code><span class="token keyword keyword-contract">contract</span> <span class="token class-name">SlippageProtection</span> <span class="token punctuation">{</span>
    <span class="token builtin">uint256</span> <span class="token keyword keyword-public">public</span> <span class="token keyword keyword-constant">constant</span> MAX_SLIPPAGE_BPS <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span> <span class="token comment">// 1% maximum allowed slippage</span>
    
    <span class="token keyword keyword-function">function</span> <span class="token function">validateSlippage</span><span class="token punctuation">(</span>
        <span class="token builtin">uint256</span> expected<span class="token punctuation">,</span>
        <span class="token builtin">uint256</span> actual
    <span class="token punctuation">)</span> <span class="token keyword keyword-internal">internal</span> <span class="token keyword keyword-pure">pure</span> <span class="token punctuation">{</span>
        <span class="token builtin">uint256</span> slippage <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>expected <span class="token operator">-</span> actual<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">10000</span><span class="token punctuation">)</span> <span class="token operator">/</span> expected<span class="token punctuation">;</span>
        <span class="token keyword keyword-require">require</span><span class="token punctuation">(</span>slippage <span class="token operator">&lt;=</span> MAX_SLIPPAGE_BPS<span class="token punctuation">,</span> <span class="token string">"Excessive slippage"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><h4 id="circuit-breakers-1">Circuit Breakers </h4>
<p>Automatically halts operations when suspicious activity is detected:</p>
<pre data-role="codeBlock" data-info="solidity" class="language-solidity solidity"><code><span class="token keyword keyword-contract">contract</span> <span class="token class-name">CircuitBreaker</span> <span class="token punctuation">{</span>
    <span class="token builtin">uint256</span> <span class="token keyword keyword-public">public</span> <span class="token keyword keyword-constant">constant</span> TRADE_VOLUME_THRESHOLD <span class="token operator">=</span> <span class="token number">1000000e18</span><span class="token punctuation">;</span> <span class="token comment">// $1M threshold</span>
    <span class="token builtin">uint256</span> <span class="token keyword keyword-public">public</span> <span class="token keyword keyword-constant">constant</span> COOL_DOWN_PERIOD <span class="token operator">=</span> <span class="token number">1</span> hours<span class="token punctuation">;</span>
    
    <span class="token builtin">uint256</span> <span class="token keyword keyword-public">public</span> lastBreakTime<span class="token punctuation">;</span>
    <span class="token builtin">uint256</span> <span class="token keyword keyword-public">public</span> currentVolume<span class="token punctuation">;</span>
    
    <span class="token keyword keyword-function">function</span> <span class="token function">checkAndBreak</span><span class="token punctuation">(</span><span class="token builtin">uint256</span> tradeAmount<span class="token punctuation">)</span> <span class="token keyword keyword-internal">internal</span> <span class="token punctuation">{</span>
        currentVolume <span class="token operator">+=</span> tradeAmount<span class="token punctuation">;</span>
        
        <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>currentVolume <span class="token operator">&gt;=</span> TRADE_VOLUME_THRESHOLD<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            lastBreakTime <span class="token operator">=</span> block<span class="token punctuation">.</span>timestamp<span class="token punctuation">;</span>
            <span class="token keyword keyword-emit">emit</span> <span class="token function">CircuitBroken</span><span class="token punctuation">(</span>currentVolume<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword keyword-revert">revert</span><span class="token punctuation">(</span><span class="token string">"Circuit breaker triggered"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><h3 id="smart-contract-security-1">Smart Contract Security </h3>
<h4 id="reentrancy-protection-1">Reentrancy Protection </h4>
<p>Guards against recursive call attacks:</p>
<pre data-role="codeBlock" data-info="solidity" class="language-solidity solidity"><code><span class="token keyword keyword-contract">contract</span> <span class="token class-name">ReentrancyGuard</span> <span class="token punctuation">{</span>
    <span class="token builtin">uint256</span> <span class="token keyword keyword-private">private</span> <span class="token keyword keyword-constant">constant</span> _NOT_ENTERED <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token builtin">uint256</span> <span class="token keyword keyword-private">private</span> <span class="token keyword keyword-constant">constant</span> _ENTERED <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token builtin">uint256</span> <span class="token keyword keyword-private">private</span> _status<span class="token punctuation">;</span>
    
    <span class="token keyword keyword-modifier">modifier</span> <span class="token function">nonReentrant</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-require">require</span><span class="token punctuation">(</span>_status <span class="token operator">!=</span> _ENTERED<span class="token punctuation">,</span> <span class="token string">"Reentrant call"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        _status <span class="token operator">=</span> _ENTERED<span class="token punctuation">;</span>
        <span class="token keyword keyword-_">_</span><span class="token punctuation">;</span>
        _status <span class="token operator">=</span> _NOT_ENTERED<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><h4 id="secure-token-transfers-1">Secure Token Transfers </h4>
<p>Ensures safe token operations with comprehensive checks:</p>
<pre data-role="codeBlock" data-info="solidity" class="language-solidity solidity"><code><span class="token keyword keyword-contract">contract</span> <span class="token class-name">SecureTransfers</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-function">function</span> <span class="token function">safeTransfer</span><span class="token punctuation">(</span>
        IERC20 token<span class="token punctuation">,</span>
        <span class="token builtin">address</span> recipient<span class="token punctuation">,</span>
        <span class="token builtin">uint256</span> amount
    <span class="token punctuation">)</span> <span class="token keyword keyword-internal">internal</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-require">require</span><span class="token punctuation">(</span>recipient <span class="token operator">!=</span> <span class="token builtin">address</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"Invalid recipient"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token builtin">uint256</span> balanceBefore <span class="token operator">=</span> token<span class="token punctuation">.</span><span class="token function">balanceOf</span><span class="token punctuation">(</span><span class="token builtin">address</span><span class="token punctuation">(</span><span class="token keyword keyword-this">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token builtin">bool</span> success <span class="token operator">=</span> token<span class="token punctuation">.</span><span class="token function">transfer</span><span class="token punctuation">(</span>recipient<span class="token punctuation">,</span> amount<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-require">require</span><span class="token punctuation">(</span>success<span class="token punctuation">,</span> <span class="token string">"Transfer failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token builtin">uint256</span> balanceAfter <span class="token operator">=</span> token<span class="token punctuation">.</span><span class="token function">balanceOf</span><span class="token punctuation">(</span><span class="token builtin">address</span><span class="token punctuation">(</span><span class="token keyword keyword-this">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-require">require</span><span class="token punctuation">(</span>
            balanceBefore <span class="token operator">-</span> balanceAfter <span class="token operator">==</span> amount<span class="token punctuation">,</span>
            <span class="token string">"Transfer amount mismatch"</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><h3 id="emergency-procedures-1">Emergency Procedures </h3>
<h4 id="emergency-shutdown-1">Emergency Shutdown </h4>
<pre data-role="codeBlock" data-info="solidity" class="language-solidity solidity"><code><span class="token keyword keyword-contract">contract</span> <span class="token class-name">EmergencyProtocol</span> <span class="token punctuation">{</span>
    <span class="token builtin">address</span> <span class="token keyword keyword-public">public</span> immutable emergencyMultisig<span class="token punctuation">;</span>
    <span class="token builtin">bool</span> <span class="token keyword keyword-public">public</span> frozen<span class="token punctuation">;</span>
    
    <span class="token keyword keyword-event">event</span> <span class="token function">EmergencyShutdown</span><span class="token punctuation">(</span><span class="token builtin">address</span> triggered_by<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-event">event</span> <span class="token function">EmergencyResume</span><span class="token punctuation">(</span><span class="token builtin">address</span> triggered_by<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword keyword-modifier">modifier</span> <span class="token function">notFrozen</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-require">require</span><span class="token punctuation">(</span><span class="token operator">!</span>frozen<span class="token punctuation">,</span> <span class="token string">"Protocol is frozen"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-_">_</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword keyword-function">function</span> <span class="token function">initiateEmergencyShutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
        <span class="token keyword keyword-external">external</span> 
        <span class="token function">onlyRole</span><span class="token punctuation">(</span>Role<span class="token punctuation">.</span>EMERGENCY_MULTISIG<span class="token punctuation">)</span> 
    <span class="token punctuation">{</span>
        frozen <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-emit">emit</span> <span class="token function">EmergencyShutdown</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword keyword-function">function</span> <span class="token function">resumeFromEmergency</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword keyword-external">external</span>
        <span class="token function">onlyRole</span><span class="token punctuation">(</span>Role<span class="token punctuation">.</span>EMERGENCY_MULTISIG<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        frozen <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-emit">emit</span> <span class="token function">EmergencyResume</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><h4 id="fund-recovery-1">Fund Recovery </h4>
<pre data-role="codeBlock" data-info="solidity" class="language-solidity solidity"><code><span class="token keyword keyword-contract">contract</span> <span class="token class-name">FundRecovery</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-function">function</span> <span class="token function">recoverTokens</span><span class="token punctuation">(</span>
        <span class="token builtin">address</span> token<span class="token punctuation">,</span>
        <span class="token builtin">address</span> recipient<span class="token punctuation">,</span>
        <span class="token builtin">uint256</span> amount
    <span class="token punctuation">)</span> <span class="token keyword keyword-external">external</span> <span class="token function">onlyRole</span><span class="token punctuation">(</span>Role<span class="token punctuation">.</span>EMERGENCY_MULTISIG<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-require">require</span><span class="token punctuation">(</span>
            recipient <span class="token operator">==</span> emergencyMultisig<span class="token punctuation">,</span>
            <span class="token string">"Can only recover to emergency multisig"</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">IERC20</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">safeTransfer</span><span class="token punctuation">(</span>recipient<span class="token punctuation">,</span> amount<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-emit">emit</span> <span class="token function">TokensRecovered</span><span class="token punctuation">(</span>token<span class="token punctuation">,</span> recipient<span class="token punctuation">,</span> amount<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><h3 id="monitoring-and-alerts-1">Monitoring and Alerts </h3>
<h4 id="critical-events-1">Critical Events </h4>
<pre data-role="codeBlock" data-info="solidity" class="language-solidity solidity"><code><span class="token keyword keyword-interface">interface</span> <span class="token class-name">ISecurityMonitor</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-event">event</span> <span class="token function">LargeTransfer</span><span class="token punctuation">(</span>
        <span class="token builtin">address</span> <span class="token keyword keyword-indexed">indexed</span> token<span class="token punctuation">,</span>
        <span class="token builtin">address</span> <span class="token keyword keyword-indexed">indexed</span> <span class="token keyword keyword-from">from</span><span class="token punctuation">,</span>
        <span class="token builtin">address</span> <span class="token keyword keyword-indexed">indexed</span> to<span class="token punctuation">,</span>
        <span class="token builtin">uint256</span> amount
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword keyword-event">event</span> <span class="token function">SlippageWarning</span><span class="token punctuation">(</span>
        <span class="token builtin">address</span> <span class="token keyword keyword-indexed">indexed</span> token<span class="token punctuation">,</span>
        <span class="token builtin">uint256</span> expected<span class="token punctuation">,</span>
        <span class="token builtin">uint256</span> actual
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword keyword-event">event</span> <span class="token function">UnauthorizedAttempt</span><span class="token punctuation">(</span>
        <span class="token builtin">address</span> <span class="token keyword keyword-indexed">indexed</span> caller<span class="token punctuation">,</span>
        <span class="token builtin">bytes4</span> functionSelector
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><h4 id="monitoring-implementation-1">Monitoring Implementation </h4>
<pre data-role="codeBlock" data-info="typescript" class="language-typescript typescript"><code><span class="token keyword keyword-class">class</span> <span class="token class-name">SecurityMonitor</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-private">private</span> <span class="token keyword keyword-readonly">readonly</span> <span class="token constant">LARGE_TRANSFER_THRESHOLD</span> <span class="token operator">=</span> ethers<span class="token punctuation">.</span>utils<span class="token punctuation">.</span><span class="token function">parseEther</span><span class="token punctuation">(</span><span class="token string">"100000"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword keyword-async">async</span> <span class="token function">monitorTransfers</span><span class="token punctuation">(</span>transfer<span class="token operator">:</span> TransferEvent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>transfer<span class="token punctuation">.</span>amount<span class="token punctuation">.</span><span class="token function">gt</span><span class="token punctuation">(</span><span class="token keyword keyword-this">this</span><span class="token punctuation">.</span><span class="token constant">LARGE_TRANSFER_THRESHOLD</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword keyword-await">await</span> <span class="token keyword keyword-this">this</span><span class="token punctuation">.</span><span class="token function">alertLargeTransfer</span><span class="token punctuation">(</span>transfer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword keyword-private">private</span> <span class="token keyword keyword-async">async</span> <span class="token function">alertLargeTransfer</span><span class="token punctuation">(</span>transfer<span class="token operator">:</span> TransferEvent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Send alerts to various channels</span>
        <span class="token keyword keyword-await">await</span> <span class="token builtin">Promise</span><span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
            <span class="token keyword keyword-this">this</span><span class="token punctuation">.</span><span class="token function">sendSlackAlert</span><span class="token punctuation">(</span>transfer<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token keyword keyword-this">this</span><span class="token punctuation">.</span><span class="token function">sendEmailAlert</span><span class="token punctuation">(</span>transfer<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token keyword keyword-this">this</span><span class="token punctuation">.</span><span class="token function">triggerPagerDuty</span><span class="token punctuation">(</span>transfer<span class="token punctuation">)</span>
        <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><h3 id="security-best-practices-1">Security Best Practices </h3>
<ol>
<li>
<p><strong>Code Review Process</strong></p>
<ul>
<li>Multiple independent auditors</li>
<li>Formal verification for critical components</li>
<li>Regular security assessments</li>
</ul>
</li>
<li>
<p><strong>Testing Requirements</strong></p>
<ul>
<li>100% test coverage for critical functions</li>
<li>Fuzz testing for edge cases</li>
<li>Integration tests with mainnet forking</li>
</ul>
</li>
<li>
<p><strong>Deployment Procedure</strong></p>
<ul>
<li>Multi-signature deployment</li>
<li>Gradual rollout strategy</li>
<li>Emergency response team on standby</li>
</ul>
</li>
<li>
<p><strong>Ongoing Maintenance</strong></p>
<ul>
<li>Regular security updates</li>
<li>Vulnerability disclosure program</li>
<li>Incident response planning</li>
</ul>
</li>
</ol>
<h2 id="best-practices-1">Best Practices </h2>
<h3 id="overview-7">Overview </h3>
<p>This document outlines the recommended best practices for developing, deploying, and maintaining AMKT v2 components. Following these guidelines helps ensure code quality, security, and maintainability.</p>
<h3 id="code-development">Code Development </h3>
<h4 id="solidity-patterns">Solidity Patterns </h4>
<h5 id="safe-math-operations">Safe Math Operations </h5>
<p>While Solidity 0.8.x includes built-in overflow checks, using SafeMath remains a best practice for:</p>
<ul>
<li>Explicit intention documentation</li>
<li>Compatibility with older code</li>
<li>Additional safety features beyond basic overflow protection</li>
<li>Consistent arithmetic handling across different Solidity versions</li>
</ul>
<pre data-role="codeBlock" data-info="solidity" class="language-solidity solidity"><code><span class="token keyword keyword-contract">contract</span> <span class="token class-name">SafeMathExample</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-using">using</span> <span class="token class-name">SafeMath</span> <span class="token keyword keyword-for">for</span> <span class="token builtin">uint256</span><span class="token punctuation">;</span>
    
    <span class="token keyword keyword-function">function</span> <span class="token function">calculateShare</span><span class="token punctuation">(</span><span class="token builtin">uint256</span> amount<span class="token punctuation">,</span> <span class="token builtin">uint256</span> total<span class="token punctuation">)</span> <span class="token keyword keyword-public">public</span> <span class="token keyword keyword-pure">pure</span> <span class="token keyword keyword-returns">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint256</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Always use SafeMath for arithmetic operations</span>
        <span class="token keyword keyword-return">return</span> amount<span class="token punctuation">.</span><span class="token function">mul</span><span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">div</span><span class="token punctuation">(</span>total<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><h5 id="check-effects-interactions-pattern">Check-Effects-Interactions Pattern </h5>
<p>This pattern is crucial for preventing reentrancy attacks. The order is important because:</p>
<ol>
<li><strong>Checks</strong>: Validate all conditions first to fail fast and save gas</li>
<li><strong>Effects</strong>: Update internal state while still holding the transaction context</li>
<li><strong>Interactions</strong>: External calls go last to prevent malicious contract callbacks</li>
</ol>
<pre data-role="codeBlock" data-info="solidity" class="language-solidity solidity"><code><span class="token keyword keyword-contract">contract</span> <span class="token class-name">CEIPattern</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-mapping">mapping</span><span class="token punctuation">(</span><span class="token builtin">address</span> <span class="token operator">=&gt;</span> <span class="token builtin">uint256</span><span class="token punctuation">)</span> <span class="token keyword keyword-private">private</span> balances<span class="token punctuation">;</span>
    
    <span class="token keyword keyword-function">function</span> <span class="token function">withdraw</span><span class="token punctuation">(</span><span class="token builtin">uint256</span> amount<span class="token punctuation">)</span> <span class="token keyword keyword-external">external</span> <span class="token punctuation">{</span>
        <span class="token comment">// 1. Checks</span>
        <span class="token keyword keyword-require">require</span><span class="token punctuation">(</span>balances<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span> <span class="token operator">&gt;=</span> amount<span class="token punctuation">,</span> <span class="token string">"Insufficient balance"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 2. Effects</span>
        balances<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span> <span class="token operator">=</span> balances<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">sub</span><span class="token punctuation">(</span>amount<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 3. Interactions</span>
        <span class="token punctuation">(</span><span class="token builtin">bool</span> success<span class="token punctuation">,</span> <span class="token punctuation">)</span> <span class="token operator">=</span> msg<span class="token punctuation">.</span>sender<span class="token punctuation">.</span>call<span class="token punctuation">{</span>value<span class="token punctuation">:</span> amount<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-require">require</span><span class="token punctuation">(</span>success<span class="token punctuation">,</span> <span class="token string">"Transfer failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><h4 id="code-organization">Code Organization </h4>
<h5 id="module-structure">Module Structure </h5>
<p>Modular design provides several benefits:</p>
<ul>
<li><strong>Separation of Concerns</strong>: Each module handles one specific aspect</li>
<li><strong>Upgradability</strong>: Modules can be upgraded independently</li>
<li><strong>Testing</strong>: Easier to test isolated functionality</li>
<li><strong>Access Control</strong>: Granular permissions per module</li>
<li><strong>Gas Optimization</strong>: Users only interact with needed modules</li>
</ul>
<pre data-role="codeBlock" data-info="solidity" class="language-solidity solidity"><code><span class="token comment">// Core functionality</span>
<span class="token keyword keyword-contract">contract</span> <span class="token class-name">AMKTCore</span> <span class="token punctuation">{</span>
    <span class="token comment">// Essential state variables and functions</span>
<span class="token punctuation">}</span>

<span class="token comment">// Additional features as separate modules</span>
<span class="token keyword keyword-contract">contract</span> <span class="token class-name">AMKTRebalancer</span> <span class="token keyword keyword-is">is</span> AMKTCore <span class="token punctuation">{</span>
    <span class="token comment">// Rebalancing specific logic</span>
<span class="token punctuation">}</span>

<span class="token keyword keyword-contract">contract</span> <span class="token class-name">AMKTGovernance</span> <span class="token keyword keyword-is">is</span> AMKTCore <span class="token punctuation">{</span>
    <span class="token comment">// Governance specific logic</span>
<span class="token punctuation">}</span>
</code></pre><h3 id="testing-guidelines">Testing Guidelines </h3>
<h4 id="unit-testing">Unit Testing </h4>
<p>Best practices for unit tests include:</p>
<ul>
<li>One assertion per test when possible</li>
<li>Descriptive test names that indicate behavior</li>
<li>Setup/teardown in beforeEach/afterEach</li>
<li>Testing both success and failure cases</li>
<li>Mock external dependencies</li>
</ul>
<pre data-role="codeBlock" data-info="typescript" class="language-typescript typescript"><code><span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">"AMKT Vault"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-let">let</span> vault<span class="token operator">:</span> AMKTVault<span class="token punctuation">;</span>
    <span class="token keyword keyword-let">let</span> token<span class="token operator">:</span> MockToken<span class="token punctuation">;</span>
    
    <span class="token function">beforeEach</span><span class="token punctuation">(</span><span class="token keyword keyword-async">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// Setup for each test</span>
        vault <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> <span class="token function">deployVault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        token <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> <span class="token function">deployMockToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">"should handle deposits correctly"</span><span class="token punctuation">,</span> <span class="token keyword keyword-async">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// Arrange</span>
        <span class="token keyword keyword-const">const</span> amount <span class="token operator">=</span> ethers<span class="token punctuation">.</span>utils<span class="token punctuation">.</span><span class="token function">parseEther</span><span class="token punctuation">(</span><span class="token string">"100"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// Act</span>
        <span class="token keyword keyword-await">await</span> vault<span class="token punctuation">.</span><span class="token function">deposit</span><span class="token punctuation">(</span>token<span class="token punctuation">.</span>address<span class="token punctuation">,</span> amount<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// Assert</span>
        <span class="token function">expect</span><span class="token punctuation">(</span><span class="token keyword keyword-await">await</span> vault<span class="token punctuation">.</span><span class="token function">balanceOf</span><span class="token punctuation">(</span>token<span class="token punctuation">.</span>address<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span>to<span class="token punctuation">.</span><span class="token function">equal</span><span class="token punctuation">(</span>amount<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><h4 id="integration-testing">Integration Testing </h4>
<p>Fork testing is essential because:</p>
<ul>
<li>Tests real protocol interactions</li>
<li>Catches integration issues early</li>
<li>Validates assumptions about external protocols</li>
<li>Ensures compatibility with mainnet state</li>
<li>Helps estimate real gas costs</li>
</ul>
<pre data-role="codeBlock" data-info="typescript" class="language-typescript typescript"><code><span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">"Integration Tests"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">before</span><span class="token punctuation">(</span><span class="token keyword keyword-async">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-await">await</span> network<span class="token punctuation">.</span>provider<span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            method<span class="token operator">:</span> <span class="token string">"hardhat_reset"</span><span class="token punctuation">,</span>
            params<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
                forking<span class="token operator">:</span> <span class="token punctuation">{</span>
                    jsonRpcUrl<span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">MAINNET_RPC</span><span class="token punctuation">,</span>
                    blockNumber<span class="token operator">:</span> <span class="token number">15000000</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">]</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">"should interact with real DeFi protocols"</span><span class="token punctuation">,</span> <span class="token keyword keyword-async">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// Test interactions with actual mainnet contracts</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><h3 id="documentation-standards">Documentation Standards </h3>
<h4 id="code-documentation">Code Documentation </h4>
<p>High-quality documentation should:</p>
<ul>
<li>Explain the "why" not just the "what"</li>
<li>Include security considerations</li>
<li>Document all parameters and return values</li>
<li>Specify units (e.g., wei vs ether)</li>
<li>Note any important state requirements</li>
</ul>
<pre data-role="codeBlock" data-info="solidity" class="language-solidity solidity"><code><span class="token comment">/// @notice Deposits tokens into the vault</span>
<span class="token comment">/// @dev Requires approval for token transfer</span>
<span class="token comment">/// @param token The address of the token to deposit</span>
<span class="token comment">/// @param amount The amount of tokens to deposit</span>
<span class="token comment">/// @return shares The number of shares minted</span>
<span class="token keyword keyword-function">function</span> <span class="token function">deposit</span><span class="token punctuation">(</span>
    <span class="token builtin">address</span> token<span class="token punctuation">,</span>
    <span class="token builtin">uint256</span> amount
<span class="token punctuation">)</span> <span class="token keyword keyword-external">external</span> <span class="token keyword keyword-returns">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint256</span> shares<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Implementation</span>
<span class="token punctuation">}</span>
</code></pre><h5 id="event-documentation">Event Documentation </h5>
<pre data-role="codeBlock" data-info="solidity" class="language-solidity solidity"><code><span class="token comment">/// @notice Emitted when tokens are deposited</span>
<span class="token comment">/// @param user The address that deposited tokens</span>
<span class="token comment">/// @param token The token that was deposited</span>
<span class="token comment">/// @param amount The amount that was deposited</span>
<span class="token comment">/// @param shares The number of shares minted</span>
<span class="token keyword keyword-event">event</span> <span class="token function">Deposit</span><span class="token punctuation">(</span>
    <span class="token builtin">address</span> <span class="token keyword keyword-indexed">indexed</span> user<span class="token punctuation">,</span>
    <span class="token builtin">address</span> <span class="token keyword keyword-indexed">indexed</span> token<span class="token punctuation">,</span>
    <span class="token builtin">uint256</span> amount<span class="token punctuation">,</span>
    <span class="token builtin">uint256</span> shares
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><h3 id="deployment-process">Deployment Process </h3>
<h4 id="deployment-checklist">Deployment Checklist </h4>
<p>A thorough deployment process should include:</p>
<ul>
<li>Multiple environment testing (testnet  staging  mainnet)</li>
<li>Gas optimization verification</li>
<li>Admin key security setup</li>
<li>Emergency procedures documentation</li>
<li>Monitoring system configuration</li>
</ul>
<pre data-role="codeBlock" data-info="typescript" class="language-typescript typescript"><code><span class="token keyword keyword-interface">interface</span> <span class="token class-name">DeploymentChecklist</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-readonly">readonly</span> steps<span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-readonly">readonly</span> preDeployment<span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token string">"Verify contract bytecode"</span><span class="token punctuation">,</span>
            <span class="token string">"Check constructor parameters"</span><span class="token punctuation">,</span>
            <span class="token string">"Confirm gas estimates"</span>
        <span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-readonly">readonly</span> deployment<span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token string">"Deploy implementation contracts"</span><span class="token punctuation">,</span>
            <span class="token string">"Initialize proxy contracts"</span><span class="token punctuation">,</span>
            <span class="token string">"Set initial parameters"</span>
        <span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-readonly">readonly</span> postDeployment<span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token string">"Verify contract addresses"</span><span class="token punctuation">,</span>
            <span class="token string">"Transfer admin rights"</span><span class="token punctuation">,</span>
            <span class="token string">"Enable functionality gradually"</span>
        <span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><h4 id="configuration-management">Configuration Management </h4>
<pre data-role="codeBlock" data-info="typescript" class="language-typescript typescript"><code><span class="token keyword keyword-interface">interface</span> <span class="token class-name">DeployConfig</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-readonly">readonly</span> network<span class="token operator">:</span> <span class="token punctuation">{</span>
        chainId<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
        name<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-readonly">readonly</span> contracts<span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token punctuation">[</span>key<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            address<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
            params<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-readonly">readonly</span> timelock<span class="token operator">:</span> <span class="token punctuation">{</span>
        minDelay<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
        proposers<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        executors<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><h3 id="monitoring-and-maintenance">Monitoring and Maintenance </h3>
<h4 id="health-checks">Health Checks </h4>
<p>Comprehensive monitoring should track:</p>
<ul>
<li>Contract state consistency</li>
<li>Balance reconciliation</li>
<li>Oracle data freshness</li>
<li>Gas price trends</li>
<li>Network conditions</li>
<li>User operation patterns</li>
</ul>
<pre data-role="codeBlock" data-info="typescript" class="language-typescript typescript"><code><span class="token keyword keyword-class">class</span> <span class="token class-name">HealthMonitor</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-async">async</span> <span class="token function">checkSystemHealth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>HealthStatus<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-const">const</span> checks <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> <span class="token builtin">Promise</span><span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
            <span class="token keyword keyword-this">this</span><span class="token punctuation">.</span><span class="token function">checkContractState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token keyword keyword-this">this</span><span class="token punctuation">.</span><span class="token function">checkTokenBalances</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token keyword keyword-this">this</span><span class="token punctuation">.</span><span class="token function">checkPriceFeeds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token keyword keyword-this">this</span><span class="token punctuation">.</span><span class="token function">checkGasPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token keyword keyword-return">return</span> <span class="token punctuation">{</span>
            healthy<span class="token operator">:</span> checks<span class="token punctuation">.</span><span class="token function">every</span><span class="token punctuation">(</span>c <span class="token operator">=&gt;</span> c<span class="token punctuation">.</span>healthy<span class="token punctuation">)</span><span class="token punctuation">,</span>
            details<span class="token operator">:</span> checks
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><h4 id="performance-optimization">Performance Optimization </h4>
<p>Key optimization strategies:</p>
<ul>
<li>Batch operations when possible</li>
<li>Use events for off-chain tracking</li>
<li>Optimize storage layout</li>
<li>Cache frequently accessed values</li>
<li>Consider view function gas costs</li>
</ul>
<pre data-role="codeBlock" data-info="solidity" class="language-solidity solidity"><code><span class="token keyword keyword-contract">contract</span> <span class="token class-name">GasOptimized</span> <span class="token punctuation">{</span>
    <span class="token comment">// Use uint256 instead of smaller uints</span>
    <span class="token builtin">uint256</span> <span class="token keyword keyword-private">private</span> <span class="token keyword keyword-constant">constant</span> PRECISION <span class="token operator">=</span> <span class="token number">1e18</span><span class="token punctuation">;</span>
    
    <span class="token comment">// Pack related storage variables</span>
    <span class="token keyword keyword-struct">struct</span> <span class="token class-name">UserInfo</span> <span class="token punctuation">{</span>
        <span class="token builtin">uint128</span> balance<span class="token punctuation">;</span>
        <span class="token builtin">uint128</span> lastUpdate<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// Use mappings for O(1) access</span>
    <span class="token keyword keyword-mapping">mapping</span><span class="token punctuation">(</span><span class="token builtin">address</span> <span class="token operator">=&gt;</span> UserInfo<span class="token punctuation">)</span> <span class="token keyword keyword-private">private</span> userInfo<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><h3 id="upgrade-procedures">Upgrade Procedures </h3>
<h4 id="safe-upgrade-pattern">Safe Upgrade Pattern </h4>
<p>Important upgrade considerations:</p>
<ul>
<li>Storage layout compatibility</li>
<li>Function selector stability</li>
<li>State migration planning</li>
<li>Rollback procedures</li>
<li>User communication strategy</li>
</ul>
<pre data-role="codeBlock" data-info="solidity" class="language-solidity solidity"><code><span class="token keyword keyword-contract">contract</span> <span class="token class-name">UpgradeableVault</span> <span class="token punctuation">{</span>
    <span class="token comment">/// @custom:oz-upgrades-unsafe-allow constructor</span>
    <span class="token keyword keyword-constructor">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">_disableInitializers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword keyword-function">function</span> <span class="token function">initialize</span><span class="token punctuation">(</span><span class="token builtin">address</span> admin<span class="token punctuation">)</span> <span class="token keyword keyword-external">external</span> initializer <span class="token punctuation">{</span>
        <span class="token function">__AccessControl_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">_grantRole</span><span class="token punctuation">(</span>DEFAULT_ADMIN_ROLE<span class="token punctuation">,</span> admin<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword keyword-function">function</span> <span class="token function">upgradeToAndCall</span><span class="token punctuation">(</span>
        <span class="token builtin">address</span> newImplementation<span class="token punctuation">,</span>
        <span class="token builtin">bytes</span> <span class="token keyword keyword-memory">memory</span> data
    <span class="token punctuation">)</span> <span class="token keyword keyword-external">external</span> <span class="token function">onlyRole</span><span class="token punctuation">(</span>UPGRADER_ROLE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">_upgradeToAndCall</span><span class="token punctuation">(</span>newImplementation<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><h3 id="error-handling">Error Handling </h3>
<h4 id="error-recovery">Error Recovery </h4>
<p>Error handling should:</p>
<ul>
<li>Distinguish between recoverable and fatal errors</li>
<li>Implement circuit breakers where appropriate</li>
<li>Log detailed error information</li>
<li>Maintain system invariants</li>
<li>Have clear escalation paths</li>
</ul>
<pre data-role="codeBlock" data-info="typescript" class="language-typescript typescript"><code><span class="token keyword keyword-class">class</span> <span class="token class-name">ErrorHandler</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-async">async</span> <span class="token function">handleTransactionError</span><span class="token punctuation">(</span>error<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token keyword keyword-void">void</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span><span class="token keyword keyword-this">this</span><span class="token punctuation">.</span><span class="token function">isRetryableError</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword keyword-await">await</span> <span class="token keyword keyword-this">this</span><span class="token punctuation">.</span><span class="token function">retryTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword keyword-else">else</span> <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span><span class="token keyword keyword-this">this</span><span class="token punctuation">.</span><span class="token function">isGasError</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword keyword-await">await</span> <span class="token keyword keyword-this">this</span><span class="token punctuation">.</span><span class="token function">adjustGasAndRetry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword keyword-else">else</span> <span class="token punctuation">{</span>
            <span class="token keyword keyword-await">await</span> <span class="token keyword keyword-this">this</span><span class="token punctuation">.</span><span class="token function">notifyAdmins</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword keyword-throw">throw</span> error<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><h3 id="community-guidelines">Community Guidelines </h3>
<p>Community interaction best practices emphasize:</p>
<ol>
<li>
<p><strong>Code Contributions</strong></p>
<ul>
<li>Detailed PR descriptions</li>
<li>Impact assessment</li>
<li>Breaking change notification</li>
<li>Benchmark comparisons</li>
<li>Security considerations</li>
</ul>
</li>
<li>
<p><strong>Issue Reporting</strong></p>
<ul>
<li>Clear reproduction steps</li>
<li>Version information</li>
<li>Related issues/PRs</li>
<li>Expected vs actual behavior</li>
<li>Impact assessment</li>
</ul>
</li>
<li>
<p><strong>Communication</strong></p>
<ul>
<li>Clear technical writing</li>
<li>Regular updates</li>
<li>Inclusive language</li>
<li>Constructive feedback</li>
<li>Knowledge sharing</li>
</ul>
</li>
</ol>

      </div>
      
      
    
    
    
    
    
    
  
    </body></html>